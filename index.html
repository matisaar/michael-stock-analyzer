<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Bosdet Labs</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230a0a0a' width='180' height='180'/><text x='90' y='115' font-size='100' text-anchor='middle'>üß™</text></svg>">
    
    <!-- Open Graph / Social Share -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Bosdet Labs üß™">
    <meta property="og:description" content="Rule #1 Investing ‚Äî Analyze stocks like Phil Town. Free fundamental analysis with sticker price calculations.">
    <meta property="og:image" content="https://bosdetlabs.com/og-image.svg">
    <meta property="og:url" content="https://bosdetlabs.com">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bosdet Labs üß™">
    <meta name="twitter:description" content="Rule #1 Investing ‚Äî Analyze stocks like Phil Town.">
    <meta name="description" content="Rule #1 Investing ‚Äî Analyze stocks like Phil Town. Free fundamental analysis with sticker price calculations.">
    <style>
        :root {
            --bg: #0a0a0a; --surface: #111; --surface-alt: #161616;
            --border: #1e1e1e; --border-hover: #333;
            --text-primary: #e8e8e8; --text-secondary: #888; --text-muted: #555; --text-faint: #333;
            --green: #22c55e; --green-muted: rgba(34,197,94,0.12);
            --red: #ef4444; --red-muted: rgba(239,68,68,0.12);
            --amber: #f59e0b; --amber-muted: rgba(245,158,11,0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); color: var(--text-primary);
            min-height: 100vh; min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overscroll-behavior-y: none; line-height: 1.4;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 16px 14px; }
        
        /* Header */
        .header { margin-bottom: 20px; padding: 8px 0; }
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .brand { font-size: 17px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; }
        .brand span { color: var(--green); }
        .header-subtitle { color: var(--text-muted); font-size: 13px; }
        
        /* Search */
        .search-box { position: relative; margin-bottom: 20px; }
        .search-wrapper { display: flex; gap: 8px; }
        .search-input { 
            padding: 12px 14px; width: 100%; flex: 1;
            background: var(--surface); border: 1px solid var(--border); border-radius: 10px; 
            color: var(--text-primary); font-size: 16px; transition: border-color 0.15s;
            min-height: 44px;
        }
        .search-input:focus { outline: none; border-color: var(--green); }
        .search-input::placeholder { color: var(--text-muted); }
        .btn { 
            padding: 12px 18px; border: none; border-radius: 10px; 
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s;
            min-height: 44px; white-space: nowrap;
        }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:active { transform: scale(0.97); }
        
        /* Section Headers */
        .section-title { color: var(--text-secondary); font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        

        .badge { font-size: 11px; padding: 4px 10px; border-radius: 8px; font-weight: 600; }
        .badge.up { background: var(--green-muted); color: var(--green); }
        .badge.down { background: var(--red-muted); color: var(--red); }
        .badge.score-high { background: var(--green-muted); color: var(--green); }
        .badge.score-medium { background: var(--amber-muted); color: var(--amber); }
        .badge.score-low { background: var(--red-muted); color: var(--red); }
        
        /* Detail View */
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .back-btn { 
            background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border); 
            padding: 10px 16px; border-radius: 10px; cursor: pointer; 
            margin-bottom: 14px; font-size: 14px; transition: all 0.15s;
            position: sticky; top: 8px; z-index: 100; backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); min-height: 44px;
        }
        .back-btn:active { color: var(--text-primary); }
        
        /* Alert Banner */
        .alert { 
            background: var(--green-muted); border: 1px solid rgba(34,197,94,0.25);
            border-radius: 12px; padding: 14px; margin-bottom: 14px;
            display: flex; align-items: center; gap: 12px;
        }
        .alert-icon { font-size: 24px; flex-shrink: 0; }
        .alert h3 { color: var(--green); font-size: 15px; margin-bottom: 2px; }
        .alert p { color: var(--text-secondary); font-size: 13px; }
        
        /* Header Card */
        .header-card { 
            background: var(--surface); border-radius: 12px; padding: 16px; 
            margin-bottom: 12px; display: flex; flex-direction: column; gap: 12px;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .stock-logo { 
            width: 44px; height: 44px; background: var(--surface-alt); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            font-size: 13px; font-weight: 700; color: var(--text-secondary); flex-shrink: 0;
            border: 1px solid var(--border);
        }
        .header-info h2 { font-size: 17px; font-weight: 650; margin-bottom: 2px; line-height: 1.2; }
        .header-info .meta { color: var(--text-muted); font-size: 12px; }
        .header-right { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
        .header-right .current-price { font-size: 26px; font-weight: 700; }
        .header-right .price-change { font-size: 13px; padding: 4px 10px; border-radius: 8px; display: inline-block; }
        
        /* Recommendation Card */
        .recommendation-card { 
            background: var(--surface); border-radius: 12px; padding: 14px;
            margin-bottom: 12px; display: flex; align-items: center; gap: 12px;
        }
        .recommendation-card .signal { font-size: 20px; font-weight: 700; white-space: nowrap; }
        .recommendation-card .reason { color: var(--text-secondary); font-size: 13px; line-height: 1.4; }
        
        /* Fair Value Card */
        .fair-value-card { 
            background: var(--surface); border: 1px solid rgba(34,197,94,0.2);
            border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            display: flex; flex-direction: column; gap: 14px;
        }
        .fair-value-card h3 { color: var(--green); font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .fair-value-card .upside { font-size: 30px; font-weight: 700; color: var(--green); }
        .fair-value-card .details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .detail-item label { display: block; color: var(--text-muted); font-size: 11px; letter-spacing: 0.02em; margin-bottom: 2px; }
        .detail-item span { font-size: 16px; font-weight: 600; }
        
        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .card { background: var(--surface); border-radius: 12px; padding: 16px; }
        .card-title { color: var(--text-muted); font-size: 12px; font-weight: 600; letter-spacing: 0.02em; margin-bottom: 12px; }
        .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); align-items: center; }
        .metric-row:last-child { border-bottom: none; }
        .metric-row .label { color: var(--text-secondary); font-size: 14px; }
        .metric-row .value { font-weight: 600; font-size: 14px; text-align: right; }
        .metric-row .value.good { color: var(--green); }
        .metric-row .value.bad { color: var(--red); }
        .metric-row .value.warn { color: var(--amber); }
        
        /* Score Card */
        .score-card { text-align: center; }
        .score-ring { width: 110px; height: 110px; margin: 0 auto 14px; position: relative; }
        .score-ring svg { transform: rotate(-90deg); width: 110px; height: 110px; }
        .score-ring circle { fill: none; stroke-width: 8; }
        .score-ring .bg { stroke: #1a1a1a; }
        .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .score-text .num { font-size: 28px; font-weight: 700; }
        .score-text .label { font-size: 11px; color: var(--text-muted); }
        .checklist { list-style: none; text-align: left; margin-top: 12px; }
        .checklist li { display: flex; align-items: flex-start; gap: 8px; padding: 6px 0; font-size: 13px; line-height: 1.4; }
        .checklist .icon { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; margin-top: 1px; }
        .checklist .icon.pass { background: var(--green); color: #000; }
        .checklist .icon.fail { background: var(--red); color: #fff; }
        .checklist .icon.warn { background: var(--amber); color: #000; }
        
        /* Loading & Error */
        .loading { text-align: center; padding: 60px 16px; }
        .spinner { width: 36px; height: 36px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: var(--text-muted); font-size: 14px; }
        .error { background: var(--red-muted); border: 1px solid rgba(239,68,68,0.2); color: var(--red); padding: 14px; border-radius: 10px; margin-bottom: 14px; text-align: center; font-size: 14px; }
        
        /* Footer */
        footer { text-align: center; color: var(--text-faint); padding: 32px 16px; font-size: 11px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 16px; color: var(--text-muted); }
        .empty-state .icon { font-size: 32px; margin-bottom: 10px; }

        /* Tabs */
        .tabs { display: flex; gap: 2px; margin-bottom: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 3px; }
        .tab { flex: 1; padding: 10px 8px; text-align: center; font-size: 13px; font-weight: 600; border-radius: 9px; cursor: pointer; color: var(--text-muted); transition: all 0.15s; border: none; background: none; min-height: 40px; }
        .tab.active { background: var(--surface-alt); color: var(--text-primary); }
        .tab:active { transform: scale(0.97); }
        .tab-badge { background: var(--green); color: #000; font-size: 10px; padding: 1px 6px; border-radius: 10px; margin-left: 4px; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Heart / Save */
        .save-btn { background: none; border: 1px solid var(--border); border-radius: 10px; width: 44px; height: 44px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
        .save-btn:active { transform: scale(0.9); }
        .save-btn.saved { border-color: var(--red); background: var(--red-muted); }
        .card-save-btn { background: none; border: none; font-size: 18px; cursor: pointer; width: 36px; height: 36px; min-width: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; opacity: 0.65; transition: all 0.15s; flex-shrink: 0; -webkit-tap-highlight-color: rgba(239,68,68,0.2); padding: 0; touch-action: manipulation; }
        .card-save-btn:hover { opacity: 1; background: rgba(255,255,255,0.06); }
        .card-save-btn:active { transform: scale(0.85); opacity: 1; }
        .card-save-btn.saved { opacity: 1; }

        /* Performance Chips */
        .perf-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .perf-chip { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; background: #161616; color: var(--text-muted); }
        .perf-chip.up { color: var(--green); background: var(--green-muted); }
        .perf-chip.down { color: var(--red); background: var(--red-muted); }
        .perf-chip .tf { color: var(--text-muted); font-weight: 400; margin-right: 2px; }

        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #111 25%, #161616 50%, #111 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-height: 120px; }
        .skeleton-line { height: 12px; margin-bottom: 10px; border-radius: 4px; }
        .skeleton-line.w60 { width: 60%; }
        .skeleton-line.w40 { width: 40%; }
        .skeleton-line.w80 { width: 80%; }
        .skeleton-line.tall { height: 24px; }

        /* Watchlist */
        .watchlist-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .watchlist-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.15s; }
        .watchlist-card:active { transform: scale(0.98); }
        .watchlist-card .wl-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .watchlist-card .wl-saved-info { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

        /* Algorithm Selector */
        .algo-select { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; font-size: 12px; font-weight: 600; cursor: pointer; -webkit-appearance: none; appearance: none; padding-right: 24px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L2 4h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; }
        .algo-select:focus { outline: none; border-color: var(--green); }

        /* Recommendations */
        .rec-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .rec-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.15s; overflow: hidden; }
        .rec-card:active { transform: scale(0.98); }
        .rec-card .r1-stats { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
        .rec-card .r1-stat { font-size: 11px; color: #888; }
        .rec-card .r1-stat .val { font-weight: 600; color: #e8e8e8; }
        .rec-card .r1-stat .val.good { color: var(--green); }
        .rec-card .r1-stat .val.bad { color: var(--red); }
        .rec-card .moat-badge { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 600; background: var(--green-muted); color: var(--green); }
        .rec-empty { text-align: center; padding: 50px 16px; }
        .rec-empty .icon { font-size: 32px; margin-bottom: 10px; }
        .rec-empty p { color: var(--text-muted); font-size: 13px; line-height: 1.5; }

        /* Toast */
        .toast { position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%) translateY(20px); background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; opacity: 0; pointer-events: none; transition: all 0.2s ease; z-index: 9999; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Suggestions */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; width: 100%; background: var(--surface); border: 1px solid var(--border-hover); border-radius: 10px; margin-top: 4px; max-height: 60vh; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 24px rgba(0,0,0,0.4); -webkit-overflow-scrolling: touch; }
        .suggestion-item { padding: 12px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); transition: background 0.1s; min-height: 44px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background: var(--surface-alt); }
        .suggestion-item .company { color: var(--text-primary); font-weight: 500; font-size: 14px; }
        .suggestion-item .ticker { background: var(--green-muted); color: var(--green); padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        
        /* Discover */
        .discover-section { margin-bottom: 24px; }
        .discover-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 12px; }
        .discover-header .section-title { margin-bottom: 0; }
        .btn-discover { padding: 8px 14px; background: var(--surface); color: var(--text-secondary); border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; min-height: 36px; white-space: nowrap; }
        .btn-discover:active { transform: scale(0.97); }
        .btn-discover:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .discover-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .discover-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.15s; -webkit-user-select: none; user-select: none; }
        .discover-card:active { transform: scale(0.98); background: var(--surface-alt); }
        .discover-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 10px; }
        .discover-card .card-header h3 { font-size: 15px; font-weight: 650; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; min-width: 0; }
        .discover-card .card-top .ticker-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .discover-card .sector-tag { font-size: 10px; color: var(--text-secondary); background: #1a1a1a; padding: 2px 7px; border-radius: 5px; font-weight: 600; white-space: nowrap; }
        .discover-card .price-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; flex-wrap: wrap; gap: 6px; }
        .discover-card .price-row .price { font-size: 22px; font-weight: 700; }
        .discover-card .mini-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .discover-card .mini-stat { font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between; padding: 3px 0; border-top: 1px solid var(--border); }
        .discover-card .mini-stat .val { font-weight: 600; color: var(--text-primary); }
        .discover-card .mini-stat .val.good { color: var(--green); }
        .discover-card .mini-stat .val.bad { color: var(--red); }
        .discover-loading { text-align: center; padding: 24px; color: var(--text-muted); font-size: 14px; }

        /* Score Points */
        .check-pts { font-size: 11px; color: var(--text-muted); font-weight: 600; min-width: 28px; text-align: right; }
        .check-pts.earned { color: var(--green); }
        
        /* Prominent Score Badge */
        .score-badge { display: flex; align-items: center; gap: 6px; padding: 4px 10px 4px 4px; border-radius: 20px; font-weight: 700; font-size: 16px; }
        .score-badge.high { background: var(--green-muted); color: var(--green); }
        .score-badge.medium { background: var(--amber-muted); color: var(--amber); }
        .score-badge.low { background: var(--red-muted); color: var(--red); }
        .score-badge .score-ring-mini { width: 28px; height: 28px; position: relative; }
        .score-badge .score-ring-mini svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .score-badge .score-ring-mini circle { fill: none; stroke-width: 3; }
        .score-badge .score-ring-mini .bg { stroke: rgba(255,255,255,0.1); }
        .score-badge .score-num { font-size: 16px; font-weight: 700; }

        /* Algorithm Detail */
        .algo-toggle { cursor: pointer; padding: 12px 0 4px; text-align: center; color: var(--text-muted); font-size: 13px; margin-top: 12px; border-top: 1px solid var(--border); -webkit-user-select: none; user-select: none; }
        .algo-toggle:active { color: var(--green); }
        .algo-detail { padding: 14px; background: #0d0d0d; border-radius: 10px; margin-top: 10px; }
        .algo-section { margin-bottom: 14px; }
        .algo-section:last-child { margin-bottom: 0; }
        .algo-section h4 { color: var(--green); font-size: 13px; margin-bottom: 6px; font-weight: 600; }
        .algo-section p { color: var(--text-secondary); font-size: 12px; line-height: 1.6; margin-bottom: 6px; }
        .algo-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #111; font-size: 12px; color: var(--text-secondary); }
        .algo-row:last-child { border-bottom: none; }
        .algo-row .pts { color: var(--green); font-weight: 600; }
        .algo-component { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; color: var(--text-secondary); }
        .algo-component .val { color: var(--text-primary); font-weight: 500; }
        .formula { font-family: 'SF Mono', Monaco, monospace; color: #aaa; font-size: 11px; background: #111; padding: 8px 12px; border-radius: 8px; margin: 6px 0; line-height: 1.5; }

        /* Rule #1 */
        .big5-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .big5-label { color: var(--text-secondary); font-size: 11px; }
        .big5-score { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 6px; }
        .big5-score.good { background: var(--green-muted); color: var(--green); }
        .big5-score.ok { background: var(--amber-muted); color: var(--amber); }
        .big5-score.bad { background: var(--red-muted); color: var(--red); }
        .sticker-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .sticker-verdict { text-align: center; margin-top: 10px; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 14px; }
        .moat-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }

        /* Trend */
        .trend { font-size: 10px; margin-left: 4px; font-weight: 700; vertical-align: middle; }
        .trend.up { color: var(--green); }
        .trend.down { color: var(--red); }

        /* ========== TABLET ========== */
        @media (min-width: 480px) {
            .container { padding: 20px 16px; }
            .brand { font-size: 19px; }
            .search-input { flex: 1; }
            .discover-grid { grid-template-columns: repeat(2, 1fr); }
            .watchlist-grid { grid-template-columns: repeat(2, 1fr); }
            .rec-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* ========== DESKTOP ========== */
        @media (min-width: 768px) {
            .container { padding: 32px 24px; }
            .header { margin-bottom: 24px; }
            .brand { font-size: 20px; }
            .search-box { margin-bottom: 28px; }
            .search-input { font-size: 16px; padding: 14px 18px; max-width: 400px; }
            .btn { font-size: 15px; padding: 14px 24px; }
            .discover-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; }
            .discover-card { padding: 18px; }
            .discover-card .card-top h3 { font-size: 16px; max-width: 200px; }
            .discover-card .price-row .price { font-size: 24px; }
            .watchlist-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
            .rec-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; }
            .tabs { max-width: 440px; margin-left: auto; margin-right: auto; margin-bottom: 24px; }
            .header-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 24px; }
            .stock-logo { width: 56px; height: 56px; font-size: 15px; }
            .header-info h2 { font-size: 22px; }
            .header-right .current-price { font-size: 32px; }
            .recommendation-card { padding: 20px; gap: 16px; }
            .recommendation-card .signal { font-size: 24px; }
            .fair-value-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 24px; }
            .fair-value-card .upside { font-size: 36px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
            .card { padding: 20px; }
            .back-btn { position: relative; top: auto; backdrop-filter: none; margin-bottom: 20px; }
            .stock-card:hover { border-color: var(--border-hover); }
            .discover-card:hover { border-color: var(--border-hover); }
            .suggestions { left: 50%; right: auto; transform: translateX(-50%); width: 400px; max-height: 280px; }
        }

        /* Bug Report */
        .bug-link { color: var(--text-muted); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; transition: color 0.15s; }
        .bug-link:active { color: var(--text-secondary); }
        .bug-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 16px; }
        .bug-overlay.open { display: flex; }
        .bug-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 24px; width: 100%; max-width: 420px; }
        .bug-modal h3 { font-size: 16px; font-weight: 650; margin-bottom: 4px; }
        .bug-modal p { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }
        .bug-modal textarea { width: 100%; min-height: 120px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 14px; font-family: inherit; resize: vertical; margin-bottom: 12px; }
        .bug-modal textarea:focus { outline: none; border-color: var(--green); }
        .bug-modal textarea::placeholder { color: var(--text-muted); }
        .bug-actions { display: flex; gap: 8px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-row">
                <div class="brand">Bosdet <span>Labs</span></div>
                <div class="header-subtitle">Research tools</div>
            </div>
        </div>
        
        <div class="search-box">
            <div class="search-wrapper">
                <input type="text" class="search-input" id="searchInput" placeholder="Search any stock or ETF..." autocomplete="off" enterkeyhint="search">
                <button class="btn btn-primary" onclick="analyze()">Analyze</button>
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Analyzing...</p>
        </div>

        <div id="mainTabs" class="tabs">
            <button class="tab active" onclick="switchTab('market')">Market</button>
            <button class="tab" onclick="switchTab('watchlist')">Saved <span id="wlCount" class="tab-badge" style="display:none">0</span></button>
            <button class="tab" onclick="switchTab('foryou')">For You</button>
        </div>

        <div id="tabMarket" class="tab-content active">
            <div id="discoverSection" class="discover-section">
                <div class="discover-header">
                    <div class="section-title">Discover</div>
                </div>
                <div id="discoverGrid" class="discover-grid"></div>
                <div id="discoverLoader" class="discover-loading" style="display:none">
                    <div class="spinner" style="width:28px;height:28px;border:2px solid #1e1e1e;border-top-color:#22c55e;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px"></div>
                    Loading more...
                </div>
            </div>
        </div>

        <div id="tabWatchlist" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                <div class="section-title" style="margin-bottom:0">Saved stocks</div>
                <div style="display:flex;align-items:center;gap:8px">
                    <span style="font-size:12px;color:#666">Score by:</span>
                    <select id="algoSelector" class="algo-select" onchange="changeAlgorithm()">
                        <option value="default">Michael's Rule #1</option>
                        <option value="value">Deep Value</option>
                        <option value="growth">Growth Focus</option>
                        <option value="quality">Quality + Moat</option>
                        <option value="dividend">Dividend Safety</option>
                    </select>
                </div>
            </div>
            <div id="watchlistGrid" class="watchlist-grid">
                <div class="empty-state"><div class="icon">‚ô°</div><p>Analyze a stock and tap the heart to save it here.</p></div>
            </div>
        </div>

        <div id="tabForyou" class="tab-content">
            <div class="section-title">Recommended for you</div>
            <div id="profileSummary" style="margin-bottom:14px"></div>
            <div id="recGrid" class="rec-grid">
                <div class="rec-empty"><div class="icon">‚Üó</div><p>Save some stocks first ‚Äî we'll analyze Rule #1 fundamentals to find quality picks.</p></div>
            </div>
        </div>
        
        <div id="detail" class="detail-view"></div>
        
        <footer>Bosdet Labs &copy; 2025 &nbsp;¬∑&nbsp; <span class="bug-link" onclick="openBugReport()">Report a bug</span></footer>
        <div id="toast" class="toast"></div>

        <!-- Bug Report Modal -->
        <div id="bugOverlay" class="bug-overlay" onclick="if(event.target===this)closeBugReport()">
            <div class="bug-modal">
                <h3>Report a bug</h3>
                <p>Describe what went wrong or what looked off. Include the stock ticker if relevant.</p>
                <textarea id="bugText" placeholder="e.g. Searched for AAPL and the score showed N/A..."></textarea>
                <div class="bug-actions">
                    <button class="btn btn-secondary" onclick="closeBugReport()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitBugReport()">Send</button>
                </div>
            </div>
        </div>
    </div>

<script>
const API_BASE = window.location.origin;

// Watchlist state - localStorage is the source of truth
let watchlistMap = {}; // symbol -> row data
let currentStockData = null;
let toastTimer = null;

// ========== SHAREABLE URLs ==========
function updateURL(symbol) {
    if (symbol) {
        history.pushState({ symbol: symbol }, '', '/' + symbol);
        document.title = symbol + ' ‚Äî Bosdet Labs';
    } else {
        history.pushState({}, '', '/');
        document.title = 'Bosdet Labs';
    }
}

function getSymbolFromURL() {
    var path = window.location.pathname;
    if (path && path.length > 1) {
        return path.substring(1).split('/')[0].toUpperCase();
    }
    var params = new URLSearchParams(window.location.search);
    return params.get('s') || params.get('symbol') || null;
}

window.addEventListener('popstate', function(e) {
    if (e.state && e.state.symbol) {
        analyze(e.state.symbol);
    } else {
        back();
    }
});

// ========== ALGORITHM SELECTOR ==========
var currentAlgo = 'default';
var algoDescriptions = {
    'default': "Michael's Rule #1 ‚Äî Phil Town style: ROA, ROE, Cash/Debt, Fair Value, Margins, P/S, FCF",
    'value': "Deep Value ‚Äî Heavy weight on P/E, P/B, dividend yield, low debt",
    'growth': "Growth Focus ‚Äî Revenue growth, earnings growth, market momentum",
    'quality': "Quality + Moat ‚Äî ROIC, margins, brand strength, competitive advantages",
    'dividend': "Dividend Safety ‚Äî Yield, payout ratio, dividend growth history"
};

function changeAlgorithm() {
    var selector = document.getElementById('algoSelector');
    currentAlgo = selector.value;
    showToast('Scoring: ' + selector.options[selector.selectedIndex].text);
    loadWatchlistView(); // Reload with new scoring
}

// ========== WATCHLIST (localStorage) ==========
function loadWatchlist() {
    try {
        var saved = localStorage.getItem('bosdet_watchlist');
        watchlistMap = saved ? JSON.parse(saved) : {};
    } catch (e) {
        watchlistMap = {};
    }
    updateWatchlistBadge();
}

function persistWatchlist() {
    try { localStorage.setItem('bosdet_watchlist', JSON.stringify(watchlistMap)); } catch(e) {}
}

function showToast(message) {
    var el = document.getElementById('toast');
    if (!el) return;
    el.textContent = message;
    el.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { el.classList.remove('show'); }, 1800);
}

function updateWatchlistBadge() {
    var count = Object.keys(watchlistMap).length;
    var badge = document.getElementById('wlCount');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

function isInWatchlist(symbol) {
    return !!watchlistMap[symbol];
}

function toggleWatchlist(symbol, name, sector, industry, score, price) {
    var willSave = !isInWatchlist(symbol);
    if (!willSave) {
        delete watchlistMap[symbol];
    } else {
        watchlistMap[symbol] = {
            symbol: symbol,
            name: name || symbol,
            sector: sector || '',
            industry: industry || '',
            score: score || 0,
            price_at_save: price || 0,
            added_at: new Date().toISOString()
        };
    }
    persistWatchlist();
    updateWatchlistBadge();
    updateAllHeartButtons(symbol);
    showToast(willSave ? 'Saved to Watchlist' : 'Removed from Watchlist');
}

function updateAllHeartButtons(symbol) {
    var saved = isInWatchlist(symbol);
    document.querySelectorAll('[data-heart="' + symbol + '"]').forEach(function(btn) {
        btn.textContent = saved ? '‚ù§Ô∏è' : 'ü§ç';
        if (saved) {
            if (btn.className.indexOf('saved') === -1) btn.className += ' saved';
        } else {
            btn.className = btn.className.replace(/ ?saved/g, '');
        }
    });
}

// ========== TABS ==========
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    
    var idx = { market: 0, watchlist: 1, foryou: 2 }[tabName] || 0;
    document.querySelectorAll('.tab')[idx].classList.add('active');
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    
    // Hide detail view when switching tabs
    document.getElementById('detail').className = 'detail-view';
    
    if (tabName === 'watchlist') loadWatchlistView();
    if (tabName === 'foryou') loadRecommendations();
}

// ========== WATCHLIST VIEW ==========
async function loadWatchlistView() {
    const grid = document.getElementById('watchlistGrid');
    const symbols = Object.keys(watchlistMap);
    
    if (symbols.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">‚ô°</div><p>Analyze a stock and tap the heart to save it here.</p></div>';
        return;
    }
    
    // Show skeleton while loading live data
    grid.innerHTML = symbols.map(function() {
        return '<div class="skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div><div class="skeleton skeleton-line tall w80"></div></div>';
    }).join('');
    
    // Helper to render cached data (fallback)
    function renderCachedData() {
        grid.innerHTML = symbols.map(function(sym) {
            var w = watchlistMap[sym];
            var savedPrice = w.price_at_save;
            return '<div class="watchlist-card" onclick="analyze(\'' + sym + '\')">' +
                '<div class="wl-top">' +
                    '<div style="min-width:0"><h3 style="font-size:16px;margin-bottom:2px">' + (w.name || sym) + '</h3><span style="color:#555;font-size:13px">' + sym + '</span></div>' +
                    '<div style="display:flex;align-items:flex-start;gap:8px">' +
                        (savedPrice ? '<div style="text-align:right"><div style="font-size:18px;font-weight:600;color:#888">Saved at $' + savedPrice.toFixed(2) + '</div></div>' : '') +
                        '<button class="card-save-btn saved" data-heart="' + sym + '" data-name="' + escapeAttr(w.name || sym) + '">‚ù§Ô∏è</button>' +
                    '</div>' +
                '</div>' +
                '<div style="font-size:12px;color:#666;margin-top:4px">Tap to load live data</div>' +
            '</div>';
        }).join('');
    }
    
    // Fetch live data for all saved stocks with current algorithm
    try {
        const resp = await fetch(API_BASE + '/api/scan?symbols=' + symbols.join(',') + '&algo=' + currentAlgo, { timeout: 15000 });
        if (!resp.ok) throw new Error('API error');
        const data = await resp.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            // Create a map for quick lookup
            const liveDataMap = {};
            data.opportunities.forEach(function(s) { liveDataMap[s.symbol] = s; });
            
            // Render all symbols, using live data when available, cached when not
            grid.innerHTML = symbols.map(function(sym) {
                const s = liveDataMap[sym];
                const wlItem = watchlistMap[sym] || {};
                const savedPrice = wlItem.price_at_save;
                
                if (s) {
                    const gainPct = savedPrice && savedPrice > 0 ? ((s.price - savedPrice) / savedPrice * 100) : null;
                    const scoreClass = s.score >= 60 ? 'high' : s.score >= 40 ? 'medium' : 'low';
                    const scoreColor = s.score >= 60 ? '#22c55e' : s.score >= 40 ? '#f59e0b' : '#ef4444';
                    const scoreBg = s.score >= 60 ? 'rgba(34,197,94,0.12)' : s.score >= 40 ? 'rgba(245,158,11,0.12)' : 'rgba(239,68,68,0.12)';
                    
                    var ct = cleanTicker(s.symbol, s.name);
                    return '<div class="watchlist-card" onclick="analyze(\'' + s.symbol + '\')">' +
                        '<div class="wl-top">' +
                            '<div style="min-width:0"><h3 style="font-size:16px;margin-bottom:2px">' + (s.name || s.symbol) + '</h3><span style="color:#555;font-size:13px">' + ct + '</span></div>' +
                            '<div style="display:flex;align-items:center;gap:10px">' +
                                '<div style="text-align:right"><div style="font-size:20px;font-weight:700">$' + s.price.toFixed(2) + '</div></div>' +
                                '<button class="card-save-btn saved" data-heart="' + s.symbol + '" data-name="' + escapeAttr(s.name) + '">‚ù§Ô∏è</button>' +
                            '</div>' +
                        '</div>' +
                        '<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">' +
                            '<div style="display:flex;align-items:center;gap:8px">' +
                                '<div style="font-size:24px;font-weight:800;color:' + scoreColor + '">' + s.score + '</div>' +
                                '<div style="font-size:11px;color:#666;line-height:1.2">Investment<br>Score</div>' +
                            '</div>' +
                            '<div style="height:4px;flex:1;margin:0 14px;border-radius:2px;background:#1e1e1e;overflow:hidden"><div style="height:100%;width:' + s.score + '%;border-radius:2px;background:' + scoreColor + '"></div></div>' +
                            (gainPct !== null ? '<div style="font-size:12px;color:' + (gainPct >= 0 ? '#22c55e' : '#ef4444') + ';font-weight:600">' + (gainPct >= 0 ? '+' : '') + gainPct.toFixed(1) + '%</div>' : '') +
                        '</div>' +
                    '</div>';
                } else {
                    // No live data for this symbol
                    return '<div class="watchlist-card" onclick="analyze(\'' + sym + '\')">' +
                        '<div class="wl-top">' +
                            '<div style="min-width:0"><h3 style="font-size:16px;margin-bottom:2px">' + (wlItem.name || sym) + '</h3><span style="color:#555;font-size:13px">' + sym + '</span></div>' +
                            '<button class="card-save-btn saved" data-heart="' + sym + '" data-name="' + escapeAttr(wlItem.name || sym) + '">‚ù§Ô∏è</button>' +
                        '</div>' +
                        (savedPrice ? '<div class="wl-saved-info" style="color:#888">Saved at $' + savedPrice.toFixed(2) + '</div>' : '') +
                    '</div>';
                }
            }).join('');
        } else {
            // Show cached data without live prices
            renderCachedData();
        }
    } catch (e) {
        console.error('Watchlist load error:', e);
        // On error, show cached data with retry option instead of just error message
        renderCachedData();
        // Add a subtle retry banner at top
        grid.insertAdjacentHTML('afterbegin', '<div style="grid-column:1/-1;background:#2a2a2a;padding:10px 14px;border-radius:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="color:#888">‚ö†Ô∏è Couldn\'t load live prices</span><button class="btn btn-secondary" style="padding:4px 12px;font-size:12px" onclick="loadWatchlistView()">Retry</button></div>');
    }
}

// ========== RECOMMENDATIONS ==========
async function loadRecommendations() {
    const grid = document.getElementById('recGrid');
    const summary = document.getElementById('profileSummary');
    
    if (Object.keys(watchlistMap).length === 0) {
        grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">‚Üó</div><p>Save some stocks first ‚Äî we\'ll analyze Rule #1 fundamentals to find quality picks.</p></div>';
        summary.innerHTML = '';
        return;
    }
    
    // Show skeleton
    grid.innerHTML = '';
    for (var i = 0; i < 6; i++) {
        grid.innerHTML += '<div class="skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div><div class="skeleton skeleton-line tall w80"></div><div class="skeleton skeleton-line w60"></div></div>';
    }
    summary.innerHTML = '<div style="color:#555;font-size:13px;text-align:center"><div class="spinner" style="width:24px;height:24px;border:2px solid #1e1e1e;border-top-color:#22c55e;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px"></div>Finding matches for your ' + Object.keys(watchlistMap).length + ' saved stocks...</div>';
    
    try {
        var items = Object.values(watchlistMap);
        const resp = await fetch(API_BASE + '/api/recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ watchlist: items })
        });
        const data = await resp.json();
        
        summary.innerHTML = '';
        
        if (data.recommendations && data.recommendations.length > 0) {
            grid.innerHTML = data.recommendations.map(function(r) {
                var scoreClass = r.score >= 60 ? 'high' : r.score >= 40 ? 'medium' : 'low';
                var scoreColor = r.score >= 60 ? '#22c55e' : r.score >= 40 ? '#f59e0b' : '#ef4444';
                var circ = 2 * Math.PI * 11;
                var off = circ - (r.score / 100) * circ;
                
                var ct = cleanTicker(r.symbol, r.name);
                return '<div class="rec-card" onclick="analyze(\'' + r.symbol + '\')">' +
                    '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">' +
                        '<div style="min-width:0"><h3 style="font-size:16px;margin-bottom:2px">' + (r.name || r.symbol) + '</h3>' +
                        '<span style="color:#555;font-size:13px">' + ct + ' ‚Ä¢ ' + (r.industry || r.sector || '') + '</span></div>' +
                        (r.has_moat ? '<span class="moat-badge">Moat</span>' : '') +
                    '</div>' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">' +
                        '<span style="font-size:22px;font-weight:700">$' + r.price.toFixed(2) + '</span>' +
                        '<div class="score-badge ' + scoreClass + '"><div class="score-ring-mini"><svg viewBox="0 0 28 28"><circle class="bg" cx="14" cy="14" r="11"></circle><circle cx="14" cy="14" r="11" stroke="' + scoreColor + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg></div><span class="score-num">' + r.score + '</span></div>' +
                    '</div>' +
                    '<div class="r1-stats">' +
                        '<span class="r1-stat">ROIC <span class="val ' + (r.roic >= 10 ? 'good' : r.roic != null && r.roic < 10 ? 'bad' : '') + '">' + (r.roic != null ? r.roic.toFixed(1) + '%' : 'N/A') + '</span></span>' +
                        '<span class="r1-stat">ROE <span class="val ' + (r.roe >= 15 ? 'good' : r.roe != null && r.roe < 10 ? 'bad' : '') + '">' + (r.roe != null ? r.roe.toFixed(1) + '%' : 'N/A') + '</span></span>' +
                        (r.revenue_growth != null ? '<span class="r1-stat">Rev <span class="val ' + (r.revenue_growth >= 10 ? 'good' : '') + '">' + r.revenue_growth.toFixed(1) + '%</span></span>' : '') +
                        (r.eps_growth != null ? '<span class="r1-stat">EPS <span class="val ' + (r.eps_growth >= 10 ? 'good' : '') + '">' + r.eps_growth.toFixed(1) + '%</span></span>' : '') +
                    '</div>' +
                '</div>';
            }).join('');
        } else if (data.message) {
            grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">‚Üó</div><p>' + data.message + '</p></div>';
        }
    } catch (e) {
        grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">‚ö†Ô∏è</div><p>Error loading recommendations. <button class="btn btn-secondary" style="margin-top:8px" onclick="loadRecommendations()">Retry</button></p></div>';
        summary.innerHTML = '';
    }
}

// ========== SEARCH ==========
let selectedIndex = -1;
let currentSuggestions = [];
let searchTimeout = null;

async function searchStocks(query) {
    if (!query || query.length < 1) return [];
    try {
        const resp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
        const data = await resp.json();
        return data.results || [];
    } catch (e) {
        return [];
    }
}

async function showSuggestions(query) {
    const suggestionsEl = document.getElementById('suggestions');
    if (!query || query.length < 1) {
        suggestionsEl.style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        return;
    }
    suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#555">Searching...</span></div>';
    suggestionsEl.style.display = 'block';
    const results = await searchStocks(query);
    currentSuggestions = results.map(function(r) { return { name: r.name, ticker: r.symbol, exchange: r.exchange, type: r.type }; });
    selectedIndex = -1;
    if (currentSuggestions.length === 0) {
        suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#888">No results. Press Enter to search "' + query.toUpperCase() + '"</span></div>';
        return;
    }
    suggestionsEl.innerHTML = currentSuggestions.map(function(m, i) {
        return '<div class="suggestion-item" data-index="' + i + '" onclick="selectSuggestion(' + i + ')">' +
            '<div style="display:flex;flex-direction:column;gap:2px"><span class="company">' + escapeHtml(m.name) + '</span>' +
            '<span style="font-size:11px;color:#555">' + (m.exchange || '') + ' ‚Ä¢ ' + (m.type || 'Stock') + '</span></div>' +
            '<span class="ticker">' + m.ticker + '</span></div>';
    }).join('');
    suggestionsEl.style.display = 'block';
}

function escapeHtml(text) { var d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function escapeAttr(text) { return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function selectSuggestion(index) {
    if (index >= 0 && index < currentSuggestions.length) {
        var s = currentSuggestions[index];
        document.getElementById('searchInput').value = s.ticker;
        document.getElementById('suggestions').style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        analyze(s.ticker);
    }
}

function updateSelectedSuggestion() {
    document.querySelectorAll('.suggestion-item').forEach(function(item, i) {
        item.classList.toggle('selected', i === selectedIndex);
    });
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('searchInput');
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        var q = this.value;
        searchTimeout = setTimeout(function() { showSuggestions(q); }, 300);
    });
    input.addEventListener('keydown', function(e) {
        var suggestionsEl = document.getElementById('suggestions');
        if (e.key === 'ArrowDown') { e.preventDefault(); if (currentSuggestions.length > 0) { selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1); updateSelectedSuggestion(); } }
        else if (e.key === 'ArrowUp') { e.preventDefault(); if (currentSuggestions.length > 0) { selectedIndex = Math.max(selectedIndex - 1, -1); updateSelectedSuggestion(); } }
        else if (e.key === 'Enter') { if (selectedIndex >= 0) { e.preventDefault(); selectSuggestion(selectedIndex); } else { suggestionsEl.style.display = 'none'; analyze(); } }
        else if (e.key === 'Escape') { suggestionsEl.style.display = 'none'; selectedIndex = -1; }
    });
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box') && !e.target.closest('.suggestions')) document.getElementById('suggestions').style.display = 'none';
    });
    
    // EVENT DELEGATION: handle all heart button clicks globally
    // Use CAPTURING phase (true) so this fires BEFORE any inline onclick or card onclick handlers
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('[data-heart]');
        if (!btn) return;
        e.stopPropagation();
        e.preventDefault();
        var symbol = btn.getAttribute('data-heart');
        var name = btn.getAttribute('data-name') || symbol;
        var sector = btn.getAttribute('data-sector') || '';
        var industry = btn.getAttribute('data-industry') || '';
        var score = parseInt(btn.getAttribute('data-score') || '0', 10);
        var price = parseFloat(btn.getAttribute('data-price') || '0');
        toggleWatchlist(symbol, name, sector, industry, score, price);
    }, true);
    
    loadWatchlist();
    loadDiscover();
    
    // Check URL for shareable link
    var urlSymbol = getSymbolFromURL();
    if (urlSymbol) {
        analyze(urlSymbol);
    }
    
    // Infinite scroll for Discover
    window.addEventListener('scroll', function() {
        if (discoverLoading || !document.getElementById('tabMarket').classList.contains('active')) return;
        var loader = document.getElementById('discoverLoader');
        if (!loader) return;
        var rect = loader.getBoundingClientRect();
        // Load more when loader is within 300px of viewport
        if (rect.top < window.innerHeight + 300) {
            loadMoreDiscover();
        }
    });
});

// ========== DISCOVER (Infinite Scroll) ==========
var discoverLoading = false;
var loadedSymbols = new Set();

async function loadDiscover() {
    var grid = document.getElementById('discoverGrid');
    var loader = document.getElementById('discoverLoader');
    
    // Reset state
    loadedSymbols.clear();
    grid.innerHTML = '';
    
    // Show initial loading
    loader.style.display = 'block';
    
    // Load first batch
    await loadMoreDiscover();
}

async function loadMoreDiscover() {
    if (discoverLoading) return;
    discoverLoading = true;
    
    var grid = document.getElementById('discoverGrid');
    var loader = document.getElementById('discoverLoader');
    loader.style.display = 'block';
    
    try {
        var resp = await fetch(API_BASE + '/api/discover');
        var data = await resp.json();
        
        if (data.picks && data.picks.length > 0) {
            // Filter out already-loaded symbols
            var newPicks = data.picks.filter(function(s) {
                return !loadedSymbols.has(s.symbol);
            });
            
            // Add to loaded set
            newPicks.forEach(function(s) {
                loadedSymbols.add(s.symbol);
            });
            
            // Append new cards
            if (newPicks.length > 0) {
                appendDiscoverCards(newPicks);
            }
        }
    } catch (e) {
        console.error('Discover error:', e);
    }
    
    loader.style.display = 'block'; // Keep loader visible for infinite scroll
    discoverLoading = false;
}

function appendDiscoverCards(picks) {
    var grid = document.getElementById('discoverGrid');
    var html = picks.map(function(s) {
        var scoreClass = s.score >= 60 ? 'high' : s.score >= 40 ? 'medium' : 'low';
        var scoreColor = s.score >= 60 ? '#22c55e' : s.score >= 40 ? '#f59e0b' : '#ef4444';
        var circ = 2 * Math.PI * 11;
        var off = circ - (s.score / 100) * circ;
        function mcap(n) { if (!n) return 'N/A'; if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T'; if (n >= 1e9) return '$' + (n/1e9).toFixed(0) + 'B'; if (n >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M'; return '$' + n; }
        var heartClass = isInWatchlist(s.symbol) ? 'card-save-btn saved' : 'card-save-btn';
        var heartIcon = isInWatchlist(s.symbol) ? '‚ù§Ô∏è' : 'ü§ç';
        var ct = cleanTicker(s.symbol, s.name);
        return '<div class="discover-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<div class="card-header"><div style="min-width:0"><h3>' + (s.name || s.symbol) + '</h3>' +
            '<div class="ticker-row"><span class="ticker" style="color:#888">' + ct + '</span><span class="sector-tag">' + (s.industry || s.sector || 'Stock') + '</span></div></div>' +
            '<button class="' + heartClass + '" data-heart="' + s.symbol + '" data-name="' + escapeAttr(s.name) + '" data-sector="' + escapeAttr(s.sector) + '" data-industry="' + escapeAttr(s.industry || '') + '" data-score="' + s.score + '" data-price="' + (s.price||0) + '">' + heartIcon + '</button></div>' +
            '<div class="price-row"><span class="price">$' + (s.price || 0).toFixed(2) + '</span>' +
            '<div class="score-badge ' + scoreClass + '"><div class="score-ring-mini"><svg viewBox="0 0 28 28"><circle class="bg" cx="14" cy="14" r="11"></circle><circle cx="14" cy="14" r="11" stroke="' + scoreColor + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg></div><span class="score-num">' + s.score + '</span></div></div>' +
            '<div class="mini-stats">' +
            '<div class="mini-stat"><span>P/E</span><span class="val">' + (s.pe_ratio != null ? s.pe_ratio.toFixed(1) + 'x' : 'N/A') + '</span></div>' +
            '<div class="mini-stat"><span>Mkt Cap</span><span class="val">' + mcap(s.market_cap) + '</span></div>' +
            '<div class="mini-stat"><span>ROA</span><span class="val ' + (s.roa > 10 ? 'good' : s.roa != null && s.roa < 0 ? 'bad' : '') + '">' + (s.roa != null ? s.roa.toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '<div class="mini-stat"><span>ROE</span><span class="val ' + (s.roe > 10 ? 'good' : s.roe != null && s.roe < 0 ? 'bad' : '') + '">' + (s.roe != null ? s.roe.toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '</div></div>';
    }).join('');
    grid.insertAdjacentHTML('beforeend', html);
}

// ========== ANALYZE ==========
async function analyze(sym) {
    var rawInput = sym || document.getElementById('searchInput').value;
    if (!rawInput || !rawInput.trim()) { showError('Please enter a stock ticker or company name'); return; }
    
    document.getElementById('suggestions').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('mainTabs').style.display = 'none';
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('detail').className = 'detail-view';
    
    var query = rawInput.trim();
    var tickerToAnalyze = query.toUpperCase();
    var looksLikeName = query.includes(' ') || query.length > 5 || query !== query.toUpperCase();
    
    if (looksLikeName) {
        setLoadingText('Searching for "' + query + '"...');
        try {
            var searchResp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
            var searchData = await searchResp.json();
            if (searchData.results && searchData.results.length > 0) {
                tickerToAnalyze = searchData.results[0].symbol;
                setLoadingText('Analyzing ' + searchData.results[0].name + ' (' + tickerToAnalyze + ')...');
            }
        } catch (e) {}
    } else {
        setLoadingText('Analyzing ' + tickerToAnalyze + '...');
    }
    
    // Don't put raw foreign tickers in search bar - will update with name after analysis
    document.getElementById('searchInput').value = tickerToAnalyze;
    
    try {
        var resp = await fetch(API_BASE + '/api/analyze/' + encodeURIComponent(tickerToAnalyze));
        var data = await resp.json();
        document.getElementById('loading').style.display = 'none';
        if (data.error) { showError(data.error); back(); return; }
        currentStockData = data;
        updateURL(data.symbol);
        // Show company name in search bar instead of raw ticker
        var displayName = (data.quote && data.quote.name) ? data.quote.name : data.symbol;
        document.getElementById('searchInput').value = displayName;
        displayAnalysis(data);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Error analyzing stock. Please try again.');
        back();
    }
}

function setLoadingText(text) {
    var p = document.getElementById('loading').querySelector('p');
    if (p) p.textContent = text;
}

function displayAnalysis(data) {
    if (data.is_etf) displayETF(data);
    else displayStock(data);
}

// ========== HELPERS ==========
function cleanTicker(symbol, name) {
    // If symbol is ugly (numeric like 398.F, or has exchange suffix), derive a clean ticker
    if (!symbol) return '';
    var base = symbol.split('.')[0];
    // If all digits (foreign exchange number), use company name abbreviation
    if (/^\d+$/.test(base) && name) {
        // Try to derive ticker from name: "Cricut, Inc." -> "CRCT", fallback to initials
        var clean = name.replace(/[,.]| Inc| Corp| Ltd| Co| Group| Holdings| Class [A-Z]/gi, '').trim();
        var words = clean.split(/\s+/).filter(function(w) { return w.length > 0; });
        if (words.length === 1) return words[0].toUpperCase().slice(0, 4);
        return words.map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 4);
    }
    return base.toUpperCase();
}
function fmtPct(v) { return v != null ? v.toFixed(1) + '%' : 'N/A'; }
function fmtRatio(v, d) { return v != null ? v.toFixed(d || 1) + 'x' : 'N/A'; }
function pctClass(v, good, warn) { if (v == null) return ''; return v > (good||10) ? 'good' : v > (warn||5) ? 'warn' : ''; }

function buildHeader(data) {
    var q = data.quote || {};
    var rec = data.recommendation || {};
    var price = q.price || 0;
    var upside = data.upside_percent || 0;
    var fairValue = data.fair_value || price;
    var score = data.investment_score || 0;
    var checks = data.checklist || [];
    
    var changeClass = (q.change_percent || 0) >= 0 ? 'up' : 'down';
    var changeSymbol = (q.change_percent || 0) >= 0 ? '‚Üë' : '‚Üì';
    var col = score >= 60 ? '#22c55e' : (score >= 40 ? '#f59e0b' : '#ef4444');
    var circ = 2 * Math.PI * 50;
    var off = circ - (score / 100) * circ;
    
    var saved = isInWatchlist(data.symbol);
    var heartHtml = '<button class="save-btn' + (saved ? ' saved' : '') + '" data-heart="' + data.symbol + '" data-name="' + escapeAttr(q.name) + '" data-sector="' + escapeAttr(q.sector) + '" data-industry="' + escapeAttr(q.industry) + '" data-score="' + score + '" data-price="' + price + '">' + (saved ? '‚ù§Ô∏è' : 'ü§ç') + '</button>';
    
    var alertHtml = '';
    if (upside > 20) {
        alertHtml = '<div class="alert"><span class="alert-icon">‚Üë</span><div><h3>Opportunity Detected</h3><p>' + (q.name || data.symbol) + ' appears to be ' + upside.toFixed(0) + '% undervalued</p></div></div>';
    }
    
    var checklistHtml = '';
    for (var i = 0; i < checks.length; i++) {
        var c = checks[i];
        var icon = c.pass === true ? '‚úì' : (c.pass === 'warn' ? '!' : '‚úó');
        var iconClass = c.pass === true ? 'pass' : (c.pass === 'warn' ? 'warn' : 'fail');
        var ptsText = c.points != null ? (c.points > 0 ? '+' + c.points : '0') : '';
        var ptsClass = c.points > 0 ? 'check-pts earned' : 'check-pts';
        checklistHtml += '<li><span class="icon ' + iconClass + '">' + icon + '</span><span style="flex:1">' + c.text + '</span>' + (ptsText !== '' ? '<span class="' + ptsClass + '">' + ptsText + '</span>' : '') + '</li>';
    }
    
    var ticker = cleanTicker(data.symbol, q.name);
    var logoText = ticker.slice(0, 4);
    
    var topSection = 
        '<button class="back-btn" onclick="back()">‚Üê Back to all stocks</button>' +
        alertHtml +
        '<div class="recommendation-card" style="border-left: 4px solid ' + (rec.color || '#666') + '">' +
            '<div><div class="signal" style="color: ' + (rec.color || '#fff') + '">' + (rec.signal || 'ANALYZING') + '</div>' +
            '<div class="reason">' + (rec.reason || '') + '</div></div>' +
        '</div>' +
        '<div class="header-card">' +
            '<div class="header-left">' +
                '<div class="stock-logo">' + logoText + '</div>' +
                '<div class="header-info"><h2>' + (q.name || data.symbol) + '</h2>' +
                '<span class="meta">' + ticker + ' ‚Ä¢ ' + (q.industry || q.sector || '') + '</span></div>' +
            '</div>' +
            '<div class="header-right" style="display:flex;align-items:center;gap:12px">' +
                '<div>' +
                    '<div class="current-price">$' + price.toFixed(2) + '</div>' +
                    '<span class="price-change badge ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(q.change_percent || 0).toFixed(2) + '% today</span>' +
                '</div>' +
                heartHtml +
            '</div>' +
        '</div>' +
        // SCORE NOW RIGHT AFTER HEADER - more prominent position
        '<div class="card score-card" style="margin-bottom:14px"><div class="card-title">‚≠ê Investment Score</div>' +
            '<div class="score-ring">' +
                '<svg viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="50"></circle><circle cx="60" cy="60" r="50" stroke="' + col + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg>' +
                '<div class="score-text"><div class="num" style="color:' + col + '">' + score + '</div><div class="label">/100</div></div>' +
            '</div>' +
            '<ul class="checklist">' + checklistHtml + '</ul>' +
        '</div>' +
        '<div id="perfRow" class="perf-row" style="margin-bottom:14px"><div class="perf-chip"><span class="tf">Loading performance...</span></div></div>' +
        '<div class="fair-value-card">' +
            '<div><h3>Calculated Upside</h3><div class="upside">' + (upside > 0 ? '+' : '') + upside.toFixed(0) + '%</div></div>' +
            '<div class="details">' +
                '<div class="detail-item"><label>Current Price</label><span>$' + price.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>Fair Value</label><span style="color:#22c55e">$' + fairValue.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>52W Range</label><span>$' + (q.week_52_low || 0).toFixed(0) + ' - $' + (q.week_52_high || 0).toFixed(0) + '</span></div>' +
            '</div>' +
        '</div>';
    
    // Score section is now included in topSection, but we return empty string for backwards compat
    var scoreSection = '';
    
    return { topSection: topSection, scoreSection: scoreSection };
}

// ========== PERFORMANCE ==========
async function loadPerformance(symbol) {
    var row = document.getElementById('perfRow');
    if (!row) return;
    try {
        var resp = await fetch(API_BASE + '/api/performance/' + symbol);
        var data = await resp.json();
        if (data.timeframes) {
            var tf = data.timeframes;
            var html = '';
            var labels = ['1D', '1W', '1M', '3M', '6M', '1Y'];
            for (var i = 0; i < labels.length; i++) {
                var key = labels[i];
                var val = tf[key];
                if (val != null) {
                    var cls = val >= 0 ? 'up' : 'down';
                    html += '<div class="perf-chip ' + cls + '"><span class="tf">' + key + '</span>' + (val >= 0 ? '+' : '') + val.toFixed(1) + '%</div>';
                }
            }
            if (data.off_high_pct != null) {
                html += '<div class="perf-chip ' + (data.off_high_pct >= 0 ? 'up' : 'down') + '"><span class="tf">vs 52W High</span>' + data.off_high_pct.toFixed(1) + '%</div>';
            }
            row.innerHTML = html || '<div class="perf-chip">No performance data</div>';
        }
    } catch (e) {
        row.innerHTML = '<div class="perf-chip">Performance unavailable</div>';
    }
}

// ========== DISPLAY STOCK ==========
function displayETF(data) {
    var f = data.fundamentals || {};
    var q = data.quote || {};
    var r = buildHeader(data);
    
    document.getElementById('detail').innerHTML = r.topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">ETF Details</div>' +
                '<div class="metric-row"><span class="label">Expense Ratio</span><span class="value ' + (f.expense_ratio != null && f.expense_ratio < 0.5 ? 'good' : '') + '">' + (f.expense_ratio != null ? f.expense_ratio.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Dividend Yield</span><span class="value ' + (f.dividend_yield > 2 ? 'good' : '') + '">' + (f.dividend_yield != null ? f.dividend_yield.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Beta</span><span class="value ' + (f.beta != null && f.beta < 1 ? 'good' : '') + '">' + (f.beta != null ? f.beta.toFixed(2) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Total Assets</span><span class="value">' + formatNum(f.total_assets) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">Performance</div>' +
                '<div class="metric-row"><span class="label">YTD Return</span><span class="value ' + (f.ytd_return > 0 ? 'good' : f.ytd_return != null ? 'bad' : '') + '">' + (f.ytd_return != null ? f.ytd_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">3-Year Avg Return</span><span class="value ' + (f.three_yr_return > 5 ? 'good' : '') + '">' + (f.three_yr_return != null ? f.three_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">5-Year Avg Return</span><span class="value ' + (f.five_yr_return > 5 ? 'good' : '') + '">' + (f.five_yr_return != null ? f.five_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
            '</div>' +
            r.scoreSection +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    loadPerformance(data.symbol);
}

function displayStock(data) {
    var f = data.fundamentals || {};
    var q = data.quote || {};
    var g = data.growth || {};
    var r1 = data.rule1 || {};
    var fvComps = data.fair_value_components || [];
    var r = buildHeader(data);
    
    function trend(dir) {
        if (dir === 'up') return '<span class="trend up">‚ñ≤</span>';
        if (dir === 'down') return '<span class="trend down">‚ñº</span>';
        return '';
    }
    
    // Rule #1 card
    var rule1Html = '';
    if (r1.big5) {
        var big5Rows = '';
        for (var i = 0; i < r1.big5.length; i++) {
            var m = r1.big5[i];
            var val = m.value != null ? m.value.toFixed(1) + m.unit : 'N/A';
            var cls = m.pass ? 'good' : (m.value != null && m.value < 0 ? 'bad' : '');
            var ico = m.pass ? ' ‚úì' : (m.value != null ? ' ‚úó' : '');
            var note = m.note ? ' <span style="color:#555;font-size:10px">(' + m.note + ')</span>' : '';
            big5Rows += '<div class="metric-row"><span class="label">' + m.name + note + '</span><span class="value ' + cls + '">' + val + ico + '</span></div>';
        }
        var b5cls = r1.big5_passing >= 4 ? 'good' : (r1.big5_passing >= 2 ? 'ok' : 'bad');
        
        var stickerHtml = '';
        if (r1.sticker) {
            var s = r1.sticker;
            stickerHtml = '<div class="sticker-section">' +
                '<div class="card-title">Sticker Price (Phil Town)</div>' +
                '<div class="metric-row"><span class="label">Growth Rate</span><span class="value">' + s.growth_rate + '% <span style="color:#555;font-size:10px">(' + s.growth_source + ')</span></span></div>' +
                '<div class="metric-row"><span class="label">Sticker Price</span><span class="value">$' + s.sticker_price.toFixed(2) + '</span></div>' +
                '<div class="metric-row"><span class="label">MOS Price (50% off)</span><span class="value" style="color:#22c55e">$' + s.mos_price.toFixed(2) + '</span></div>' +
                '<div class="metric-row"><span class="label">Current Price</span><span class="value">$' + s.current_price.toFixed(2) + '</span></div>' +
                '<div class="sticker-verdict" style="background:' + s.verdict_color + '20;color:' + s.verdict_color + '">' + s.verdict + '</div>' +
            '</div>';
        }
        
        var moatHtml = '<div class="moat-row"><div class="metric-row"><span class="label">Moat</span><span class="value ' + (r1.has_moat ? 'good' : 'warn') + '">' + (r1.has_moat ? 'Strong' : 'Uncertain') + '</span></div></div>';
        
        rule1Html = '<div class="card">' +
            '<div class="card-title">Rule #1 Investing</div>' +
            '<div class="big5-header"><span class="big5-label">Big 5 Numbers</span><span class="big5-score ' + b5cls + '">' + r1.big5_passing + '/' + r1.big5_total + ' passing</span></div>' +
            big5Rows + moatHtml + stickerHtml +
        '</div>';
    }
    
    // Algorithm detail
    var fvCompHtml = '';
    for (var j = 0; j < fvComps.length; j++) {
        fvCompHtml += '<div class="algo-component"><span>' + fvComps[j].label + '</span><span class="val">$' + fvComps[j].value.toFixed(2) + '</span></div>';
    }
    
    var stickerFormulaHtml = '';
    if (r1.sticker) {
        var st = r1.sticker;
        stickerFormulaHtml = '<div class="algo-section">' +
            '<h4>Rule #1 Sticker Price Formula</h4>' +
            '<div class="formula">Sticker = EPS √ó (1+g)¬π‚Å∞ √ó min(2√óg%, 50) √∑ 1.15¬π‚Å∞<br>MOS Price = Sticker √∑ 2</div>' +
            '<div class="algo-component"><span>Current EPS</span><span class="val">$' + st.eps.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>Growth Rate (' + st.growth_source + ')</span><span class="val">' + st.growth_rate + '%</span></div>' +
            '<div class="algo-component"><span>Future EPS (10yr)</span><span class="val">$' + st.future_eps.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>Future PE (2 √ó growth%)</span><span class="val">' + st.future_pe.toFixed(1) + 'x</span></div>' +
            '<div class="algo-component"><span>Future Market Price</span><span class="val">$' + st.future_price.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>√∑ 1.15¬π‚Å∞ (15% MARR) = Sticker</span><span class="val">$' + st.sticker_price.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>√∑ 2 (50% MOS) = Buy Price</span><span class="val" style="color:#22c55e">$' + st.mos_price.toFixed(2) + '</span></div>' +
        '</div>';
    }
    
    var algoHtml = '<div class="card" style="grid-column:1/-1">' +
        '<div class="algo-toggle" onclick="toggleAlgo()">How everything is calculated ‚ñº</div>' +
        '<div id="algoDetail" class="algo-detail" style="display:none">' +
            '<div class="algo-section">' +
                '<h4>üìä Default Score ‚Äî Michael\'s Rule #1 (100 pts)</h4>' +
                '<p>Proportional scoring ‚Äî points scale with how well each metric performs, not pass/fail.</p>' +
                '<div class="algo-row"><span>Return on Assets (ROA)</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Scales linearly: ‚àí5% ‚Üí 0 pts, 15%+ ‚Üí 15 pts</span><span></span></div>' +
                '<div class="algo-row"><span>Return on Equity (ROE)</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Scales linearly: ‚àí5% ‚Üí 0 pts, 15%+ ‚Üí 15 pts</span><span></span></div>' +
                '<div class="algo-row"><span>Cash / Debt Coverage</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Based on cash√∑debt ratio: 2x+ coverage ‚Üí 15 pts. No debt ‚Üí full credit</span><span></span></div>' +
                '<div class="algo-row"><span>Fair Value Upside</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Based on % undervalued vs blended fair value: 50%+ ‚Üí 20 pts, 0% ‚Üí 0 pts</span><span></span></div>' +
                '<div class="algo-row"><span>Profit Margin</span><span class="pts">10 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Scales linearly: ‚àí5% ‚Üí 0 pts, 20%+ ‚Üí 10 pts</span><span></span></div>' +
                '<div class="algo-row"><span>Price / Sales Ratio</span><span class="pts">10 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">Lower is better: P/S &lt; 1 ‚Üí 10 pts, P/S 5+ ‚Üí 0 pts</span><span></span></div>' +
                '<div class="algo-row"><span>Free Cash Flow Yield</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span style="color:#555;font-size:11px;padding-left:8px">FCF √∑ Market Cap: 10%+ yield ‚Üí 15 pts, proportional below</span><span></span></div>' +
                '<div class="algo-row" style="border-top:2px solid #1e1e1e;padding-top:6px;margin-top:4px;font-weight:600;color:#888"><span>Maximum Score</span><span class="pts">100 pts</span></div>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üíé Deep Value Algorithm</h4>' +
                '<p>Emphasizes cheap multiples, dividends, and low debt for bargain hunters.</p>' +
                '<div class="algo-row"><span>Low P/E Ratio ‚Äî PE &lt; 10 ‚Üí full pts</span><span class="pts">25 pts</span></div>' +
                '<div class="algo-row"><span>Low P/B Ratio ‚Äî PB &lt; 1 ‚Üí full pts</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Dividend Yield ‚Äî scales with yield %</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Low Debt/Equity ‚Äî D/E &lt; 0.5 ‚Üí full pts</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>FCF Yield</span><span class="pts">20 pts</span></div>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üöÄ Growth Focus Algorithm</h4>' +
                '<p>Prioritizes companies with strong revenue and earnings momentum.</p>' +
                '<div class="algo-row"><span>Revenue Growth ‚Äî scales with growth %</span><span class="pts">30 pts</span></div>' +
                '<div class="algo-row"><span>Earnings Growth</span><span class="pts">25 pts</span></div>' +
                '<div class="algo-row"><span>High ROE ‚Äî ability to compound</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Profit Margin ‚Äî scalable profitability</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Momentum Bonus ‚Äî undervalued = +10</span><span class="pts">10 pts</span></div>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üè∞ Quality + Moat Algorithm</h4>' +
                '<p>Scores competitive advantages ‚Äî high returns, pricing power, and cash generation.</p>' +
                '<div class="algo-row"><span>ROE (ROIC proxy) ‚Äî consistent high returns</span><span class="pts">25 pts</span></div>' +
                '<div class="algo-row"><span>ROA ‚Äî asset efficiency</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Gross Margin ‚Äî pricing power</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Profit Margin ‚Äî operating efficiency</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>FCF Yield ‚Äî cash generation</span><span class="pts">20 pts</span></div>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üí∞ Dividend Safety Algorithm</h4>' +
                '<p>Evaluates whether dividends are sustainable and well-covered.</p>' +
                '<div class="algo-row"><span>Dividend Yield ‚Äî 5%+ ‚Üí full pts</span><span class="pts">25 pts</span></div>' +
                '<div class="algo-row"><span>Payout Ratio ‚Äî 30-60% ideal zone</span><span class="pts">25 pts</span></div>' +
                '<div class="algo-row"><span>Positive Free Cash Flow ‚Äî can afford dividends</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Low Debt/Equity ‚Äî safety buffer</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Profit Margin ‚Äî earnings stability</span><span class="pts">15 pts</span></div>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üìê Fair Value Calculation</h4>' +
                '<p>Blended average of ' + fvComps.length + ' valuation model(s):</p>' +
                fvCompHtml +
                '<div class="algo-component" style="border-top:2px solid #1e1e1e;padding-top:6px;margin-top:6px;font-weight:600"><span style="color:#888">= Blended Fair Value</span><span class="val" style="color:#22c55e">$' + (data.fair_value || 0).toFixed(2) + '</span></div>' +
                '<p style="margin-top:6px;font-size:11px;color:#555">Models used when data is available: analyst consensus target, forward PE fair value, PEG growth-adjusted PE, and sector PE comparison.</p>' +
            '</div>' +
            stickerFormulaHtml +
        '</div></div>';
    
    document.getElementById('detail').innerHTML = r.topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üí∞ Valuation</div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
                '<div class="metric-row"><span class="label">Forward PE</span><span class="value">' + fmtRatio(f.forward_pe) + '</span></div>' +
                '<div class="metric-row"><span class="label">PEG Ratio</span><span class="value">' + fmtRatio(f.peg_ratio) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/S Ratio</span><span class="value ' + (f.ps_ratio != null && f.ps_ratio < 2 ? 'good' : '') + '">' + fmtRatio(f.ps_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/B Ratio</span><span class="value">' + fmtRatio(f.pb_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">Market Cap</span><span class="value">' + formatNum(q.market_cap) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">Profitability & Growth</div>' +
                '<div class="metric-row"><span class="label">ROA</span><span class="value ' + pctClass(f.roa) + '">' + fmtPct(f.roa) + '</span></div>' +
                '<div class="metric-row"><span class="label">ROE</span><span class="value ' + pctClass(f.roe) + '">' + fmtPct(f.roe) + '</span></div>' +
                '<div class="metric-row"><span class="label">Profit Margin</span><span class="value ' + pctClass(f.profit_margin, 10, 5) + '">' + fmtPct(f.profit_margin) + '</span></div>' +
                '<div class="metric-row"><span class="label">Gross Margin</span><span class="value">' + fmtPct(f.gross_margin) + '</span></div>' +
                (g.revenue != null ? '<div class="metric-row"><span class="label">Revenue Growth' + trend(g.revenue_trend) + '</span><span class="value ' + (g.revenue > 10 ? 'good' : g.revenue > 0 ? 'warn' : 'bad') + '">' + g.revenue.toFixed(1) + '%</span></div>' : '') +
                (g.earnings != null ? '<div class="metric-row"><span class="label">Earnings Growth' + trend(g.earnings_trend) + '</span><span class="value ' + (g.earnings > 10 ? 'good' : g.earnings > 0 ? 'warn' : 'bad') + '">' + g.earnings.toFixed(1) + '%</span></div>' : '') +
            '</div>' +
            '<div class="card"><div class="card-title">üè¶ Balance Sheet</div>' +
                '<div class="metric-row"><span class="label">Cash</span><span class="value ' + (f.cash ? 'good' : '') + '">' + formatNum(f.cash) + '</span></div>' +
                '<div class="metric-row"><span class="label">Debt</span><span class="value ' + (f.debt > f.cash ? 'bad' : '') + '">' + formatNum(f.debt) + '</span></div>' +
                '<div class="metric-row"><span class="label">Net Cash</span><span class="value ' + (f.cash >= f.debt ? 'good' : 'bad') + '">' + (f.cash != null && f.debt != null ? formatNum(f.cash - f.debt) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Free Cash Flow</span><span class="value ' + (f.fcf > 0 ? 'good' : f.fcf != null ? 'bad' : '') + '">' + formatNum(f.fcf) + '</span></div>' +
            '</div>' +
            rule1Html +
            r.scoreSection +
            algoHtml +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    loadPerformance(data.symbol);
}

function toggleAlgo() {
    var el = document.getElementById('algoDetail');
    var toggle = document.querySelector('.algo-toggle');
    if (el.style.display === 'none') {
        el.style.display = 'block';
        toggle.textContent = 'üî¨ Hide Algorithm Details ‚ñ≤';
    } else {
        el.style.display = 'none';
        toggle.textContent = 'üî¨ View Algorithm Details ‚Äî How Everything is Calculated ‚ñº';
    }
}

function back() {
    document.getElementById('detail').className = 'detail-view';
    document.getElementById('mainTabs').style.display = 'flex';
    // Re-show the active tab content
    var activeTab = document.querySelector('.tab.active');
    if (activeTab) {
        var tabName = activeTab.textContent.includes('Market') ? 'market' : activeTab.textContent.includes('Saved') ? 'watchlist' : 'foryou';
        document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    } else {
        document.getElementById('tabMarket').classList.add('active');
    }
    updateURL(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
    setTimeout(function() { document.getElementById('error').style.display = 'none'; }, 5000);
}

function formatNum(n) {
    if (n === null || n === undefined) return 'N/A';
    if (n === 0) return '$0';
    if (Math.abs(n) >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
    if (Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}

// ========== BUG REPORT ==========
function openBugReport() {
    document.getElementById('bugOverlay').classList.add('open');
    document.getElementById('bugText').value = '';
    document.getElementById('bugText').focus();
}
function closeBugReport() {
    document.getElementById('bugOverlay').classList.remove('open');
}
async function submitBugReport() {
    var msg = document.getElementById('bugText').value.trim();
    if (!msg) { showToast('Please describe the issue'); return; }
    closeBugReport();
    
    // Save locally so reports are never lost
    var reports = JSON.parse(localStorage.getItem('bosdet_bugs') || '[]');
    reports.push({ message: msg, page: currentStockData ? currentStockData.symbol : 'home', time: new Date().toISOString() });
    localStorage.setItem('bosdet_bugs', JSON.stringify(reports));
    
    showToast('Sending report...');
    try {
        await fetch(API_BASE + '/api/bug-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, page: window.location.href + ' | ' + (currentStockData ? currentStockData.symbol : 'no stock') })
        });
        showToast('Bug reported ‚Äî thanks! We\'ll look into it.');
    } catch(e) {
        showToast('Saved locally ‚Äî will send when online');
    }
}
</script>
</body>
</html>