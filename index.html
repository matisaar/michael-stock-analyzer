<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Michael's Stock Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%); 
            color: #fff; min-height: 100vh; min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overscroll-behavior-y: none;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px 12px; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 24px; }
        .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .header h1 span { background: linear-gradient(135deg, #00d374, #00a060); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #666; font-size: 13px; line-height: 1.4; }
        
        /* Search */
        .search-box { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }
        .search-input { 
            padding: 14px 16px; width: 100%; flex: 1 1 100%;
            background: #151515; border: 2px solid #222; border-radius: 12px; 
            color: #fff; font-size: 16px; transition: all 0.2s;
            min-height: 48px;
        }
        .search-input:focus { outline: none; border-color: #00d374; background: #1a1a1a; }
        .search-input::placeholder { color: #555; }
        .btn { 
            padding: 14px 20px; border: none; border-radius: 12px; 
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 48px; flex: 1 1 0;
        }
        .btn-primary { background: linear-gradient(135deg, #00d374, #00a060); color: #000; }
        .btn-primary:hover { box-shadow: 0 8px 20px rgba(0,211,116,0.3); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background: #1a1a1a; color: #fff; border: 2px solid #333; }
        .btn-secondary:hover { border-color: #00d374; }
        .btn-secondary:active { transform: scale(0.97); }
        
        /* Stock Grid */
        .section-title { color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
        .stock-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px; }
        .stock-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border: 1px solid #222; border-radius: 16px; padding: 18px; 
            cursor: pointer; transition: all 0.2s;
            -webkit-user-select: none; user-select: none;
        }
        .stock-card:active { transform: scale(0.98); background: #181818; }
        .stock-card h3 { font-size: 16px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stock-card .ticker { color: #666; font-size: 13px; font-weight: 500; }
        .stock-card .price { font-size: 24px; font-weight: 700; margin-top: 12px; }
        .stock-card .badges { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .badge { font-size: 12px; padding: 5px 10px; border-radius: 8px; font-weight: 600; }
        .badge.up { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.down { background: rgba(255,82,82,0.15); color: #ff5252; }
        .badge.score-high { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.score-medium { background: rgba(255,184,0,0.15); color: #ffb800; }
        .badge.score-low { background: rgba(255,82,82,0.15); color: #ff5252; }
        
        /* Detail View */
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .back-btn { 
            background: #1a1a1a; color: #888; border: 1px solid #333; 
            padding: 12px 20px; border-radius: 10px; cursor: pointer; 
            margin-bottom: 16px; font-size: 14px; transition: all 0.2s;
            position: sticky; top: 8px; z-index: 100; backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); min-height: 44px;
        }
        .back-btn:active { background: #252525; color: #fff; }
        
        /* Alert Banner */
        .alert { 
            background: linear-gradient(135deg, rgba(0,211,116,0.1), rgba(0,211,116,0.03)); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 14px; 
            padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;
        }
        .alert-icon { font-size: 28px; flex-shrink: 0; }
        .alert h3 { color: #00d374; font-size: 16px; margin-bottom: 2px; }
        .alert p { color: #888; font-size: 13px; }
        
        /* Header Card */
        .header-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 16px; padding: 18px; margin-bottom: 14px; 
            display: flex; flex-direction: column; gap: 14px;
        }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .stock-logo { 
            width: 52px; height: 52px; 
            background: linear-gradient(135deg, #00d374, #00a060); 
            border-radius: 14px; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 700; color: #000; flex-shrink: 0;
        }
        .header-info h2 { font-size: 18px; margin-bottom: 2px; line-height: 1.2; }
        .header-info .meta { color: #666; font-size: 12px; }
        .header-right { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; }
        .header-right .current-price { font-size: 28px; font-weight: 700; }
        .header-right .price-change { font-size: 14px; padding: 6px 12px; border-radius: 8px; display: inline-block; }
        
        /* Recommendation Card */
        .recommendation-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 14px; padding: 16px; margin-bottom: 14px;
            display: flex; align-items: center; gap: 14px;
        }
        .recommendation-card .signal { font-size: 22px; font-weight: 700; white-space: nowrap; }
        .recommendation-card .reason { color: #888; font-size: 13px; line-height: 1.4; }
        
        /* Fair Value Card */
        .fair-value-card { 
            background: linear-gradient(135deg, #0d3320, #0a1a10); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 16px; 
            padding: 18px; margin-bottom: 14px; 
            display: flex; flex-direction: column; gap: 16px;
        }
        .fair-value-card h3 { color: #00d374; font-size: 14px; margin-bottom: 4px; }
        .fair-value-card .upside { font-size: 34px; font-weight: 700; color: #00d374; }
        .fair-value-card .details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .detail-item label { display: block; color: #666; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .detail-item span { font-size: 16px; font-weight: 600; }
        
        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .card { background: linear-gradient(145deg, #151515, #111); border-radius: 14px; padding: 18px; }
        .card-title { color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; }
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1a1a1a; align-items: center; }
        .metric-row:last-child { border-bottom: none; }
        .metric-row .label { color: #888; font-size: 14px; }
        .metric-row .value { font-weight: 600; font-size: 14px; text-align: right; }
        .metric-row .value.good { color: #00d374; }
        .metric-row .value.bad { color: #ff5252; }
        .metric-row .value.warn { color: #ffb800; }
        
        /* Score Card */
        .score-card { text-align: center; }
        .score-ring { width: 120px; height: 120px; margin: 0 auto 16px; position: relative; }
        .score-ring svg { transform: rotate(-90deg); width: 120px; height: 120px; }
        .score-ring circle { fill: none; stroke-width: 10; }
        .score-ring .bg { stroke: #222; }
        .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .score-text .num { font-size: 30px; font-weight: 700; }
        .score-text .label { font-size: 11px; color: #666; }
        .checklist { list-style: none; text-align: left; margin-top: 14px; }
        .checklist li { display: flex; align-items: flex-start; gap: 10px; padding: 7px 0; font-size: 13px; line-height: 1.4; }
        .checklist .icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; margin-top: 1px; }
        .checklist .icon.pass { background: #00d374; color: #000; }
        .checklist .icon.fail { background: #ff5252; color: #fff; }
        .checklist .icon.warn { background: #ffb800; color: #000; }
        
        /* Loading & Error */
        .loading { text-align: center; padding: 60px 16px; }
        .spinner { width: 44px; height: 44px; border: 3px solid #222; border-top-color: #00d374; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: #666; font-size: 14px; }
        .error { background: rgba(255,82,82,0.1); border: 1px solid rgba(255,82,82,0.3); color: #ff5252; padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center; font-size: 14px; }
        
        /* Footer */
        footer { text-align: center; color: #333; padding: 30px 16px; font-size: 12px; }
        footer a { color: #00d374; text-decoration: none; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 16px; color: #555; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        
        /* Suggestions Dropdown */
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            width: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            margin-top: 4px;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            -webkit-overflow-scrolling: touch;
        }
        .suggestion-item {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
            transition: background 0.15s;
            min-height: 48px;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background: #252525; }
        .suggestion-item .company { color: #fff; font-weight: 500; }
        .suggestion-item .ticker { 
            background: rgba(0,211,116,0.15); 
            color: #00d374; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 600;
        }
        .search-wrapper { position: relative; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        
        /* Discover Section */
        .discover-section { margin-bottom: 28px; }
        .discover-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; gap: 12px; }
        .discover-header .section-title { margin-bottom: 0; font-size: 12px; }
        .btn-discover { 
            padding: 10px 16px; background: linear-gradient(135deg, #6c5ce7, #a855f7); 
            color: #fff; border: none; border-radius: 10px; font-size: 13px; 
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 44px; white-space: nowrap; flex-shrink: 0;
        }
        .btn-discover:active { transform: scale(0.97); }
        .btn-discover:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .discover-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .discover-card {
            background: linear-gradient(145deg, #151515, #111);
            border: 1px solid #222; border-radius: 16px; padding: 18px;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }
        .discover-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #6c5ce7, #a855f7);
        }
        .discover-card:active { transform: scale(0.98); background: #181818; }
        .discover-card .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 8px; }
        .discover-card .card-top h3 { font-size: 16px; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .discover-card .sector-tag { font-size: 10px; color: #a855f7; background: rgba(168,85,247,0.15); padding: 4px 8px; border-radius: 6px; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .discover-card .price-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; flex-wrap: wrap; gap: 6px; }
        .discover-card .price-row .price { font-size: 24px; font-weight: 700; }
        .discover-card .mini-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .discover-card .mini-stat { font-size: 12px; color: #888; display: flex; justify-content: space-between; padding: 4px 0; border-top: 1px solid #1a1a1a; }
        .discover-card .mini-stat .val { font-weight: 600; color: #ccc; }
        .discover-card .mini-stat .val.good { color: #00d374; }
        .discover-card .mini-stat .val.bad { color: #ff5252; }
        .discover-loading { text-align: center; padding: 30px; color: #666; font-size: 14px; }

        /* ========== TABLET (sm-up) ========== */
        @media (min-width: 480px) {
            .container { padding: 20px 16px; }
            .header h1 { font-size: 28px; }
            .header p { font-size: 14px; }
            .search-input { flex: 1 1 auto; }
            .btn { flex: 0 0 auto; padding: 14px 24px; }
            .stock-grid { grid-template-columns: repeat(2, 1fr); }
            .discover-grid { grid-template-columns: repeat(2, 1fr); }
            .discover-card .card-top h3 { max-width: 180px; }
        }

        /* ========== DESKTOP (md-up) ========== */
        @media (min-width: 768px) {
            .container { padding: 30px 24px; }
            .header { margin-bottom: 36px; }
            .header h1 { font-size: 34px; }
            .header p { font-size: 16px; }
            .search-box { margin-bottom: 36px; }
            .search-input { font-size: 18px; padding: 16px 24px; max-width: 420px; }
            .btn { font-size: 16px; padding: 16px 32px; }
            .section-title { font-size: 14px; margin-bottom: 20px; }
            .stock-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
            .stock-card { padding: 24px; border-radius: 20px; }
            .stock-card h3 { font-size: 18px; }
            .stock-card .price { font-size: 28px; margin-top: 16px; }
            .badge { font-size: 13px; padding: 6px 12px; }
            .discover-section { margin-bottom: 40px; }
            .discover-header .section-title { font-size: 14px; }
            .discover-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .discover-card { padding: 24px; border-radius: 20px; }
            .discover-card .card-top h3 { font-size: 18px; max-width: 200px; }
            .discover-card .price-row .price { font-size: 28px; }
            .header-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 28px; border-radius: 20px; }
            .stock-logo { width: 70px; height: 70px; font-size: 18px; }
            .header-info h2 { font-size: 24px; }
            .header-info .meta { font-size: 14px; }
            .header-right .current-price { font-size: 36px; }
            .header-right .price-change { font-size: 16px; padding: 8px 16px; }
            .recommendation-card { padding: 24px; gap: 20px; border-radius: 16px; }
            .recommendation-card .signal { font-size: 28px; }
            .recommendation-card .reason { font-size: 15px; }
            .fair-value-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 28px; border-radius: 20px; }
            .fair-value-card .upside { font-size: 42px; }
            .fair-value-card .details { gap: 40px; }
            .detail-item label { font-size: 12px; }
            .detail-item span { font-size: 22px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
            .card { padding: 24px; border-radius: 16px; }
            .card-title { font-size: 13px; margin-bottom: 20px; }
            .metric-row { padding: 12px 0; }
            .metric-row .label { font-size: 15px; }
            .metric-row .value { font-size: 15px; }
            .score-ring { width: 140px; height: 140px; }
            .score-ring svg { width: 140px; height: 140px; }
            .score-text .num { font-size: 36px; }
            .back-btn { position: relative; top: auto; backdrop-filter: none; margin-bottom: 24px; }
            .back-btn:hover { color: #fff; border-color: #444; }
            .btn-primary:hover { transform: translateY(-2px); }
            .stock-card:hover { border-color: #00d374; transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
            .discover-card:hover { border-color: #a855f7; transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
            .btn-discover:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(168,85,247,0.3); }
            .suggestions { left: 50%; right: auto; transform: translateX(-50%); width: 420px; max-height: 300px; }
            .loading { padding: 80px 20px; }
            .loading p { font-size: 16px; }
            .error { padding: 20px; margin-bottom: 20px; }
            footer { padding: 40px 20px; font-size: 13px; }
            .empty-state { padding: 60px 20px; }
            .empty-state .icon { font-size: 48px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà <span>Michael's Stock Analyzer</span></h1>
            <p>Smart investment analysis ‚Ä¢ ROA/ROE &gt;10% ‚Ä¢ Cash vs Debt ‚Ä¢ Fair Value</p>
        </div>
        
        <div class="search-box" style="position: relative;">
            <input type="text" class="search-input" id="searchInput" placeholder="Ticker or company (e.g. Apple, TSLA)" autocomplete="off" enterkeyhint="search">
            <button class="btn btn-primary" onclick="analyze()">üîç Analyze</button>
            <button class="btn btn-secondary" onclick="scanOpportunities()">üìä Refresh</button>
            <div id="suggestions" class="suggestions"></div>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Analyzing stocks...</p>
        </div>
        
        <div id="discoverSection" class="discover-section">
            <div class="discover-header">
                <div class="section-title">üé≤ Discover Random Stocks</div>
                <button class="btn-discover" id="discoverBtn" onclick="loadDiscover()">üîÑ Shuffle New Picks</button>
            </div>
            <div id="discoverGrid" class="discover-grid">
                <div class="discover-loading">Click "Shuffle New Picks" to discover stocks!</div>
            </div>
        </div>
        
        <div id="grid">
            <div class="section-title">üìä Top Stocks to Analyze</div>
            <div class="stock-grid" id="stockGrid"></div>
        </div>
        
        <div id="detail" class="detail-view"></div>
        
        <footer>
            Built with ‚ù§Ô∏è for Michael
        </footer>
    </div>

<script>
const API_BASE = window.location.origin;

let selectedIndex = -1;
let currentSuggestions = [];
let searchTimeout = null;

// Live search using Yahoo Finance API
async function searchStocks(query) {
    if (!query || query.length < 1) return [];
    
    try {
        const resp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
        const data = await resp.json();
        return data.results || [];
    } catch (e) {
        console.error('Search error:', e);
        return [];
    }
}

async function showSuggestions(query) {
    const suggestionsEl = document.getElementById('suggestions');
    
    if (!query || query.length < 1) {
        suggestionsEl.style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        return;
    }
    
    // Show loading state
    suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#666">üîç Searching...</span></div>';
    suggestionsEl.style.display = 'block';
    
    // Fetch results from API
    const results = await searchStocks(query);
    
    currentSuggestions = results.map(r => ({
        name: r.name,
        ticker: r.symbol,
        exchange: r.exchange,
        type: r.type
    }));
    selectedIndex = -1;
    
    if (currentSuggestions.length === 0) {
        // No results - but user can still try their input as a ticker
        suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#888">No results. Press Enter to search "' + query.toUpperCase() + '"</span></div>';
        return;
    }
    
    suggestionsEl.innerHTML = currentSuggestions.map((m, i) => 
        '<div class="suggestion-item" data-index="' + i + '" onclick="selectSuggestion(' + i + ')">' +
            '<div style="display:flex;flex-direction:column;gap:2px">' +
                '<span class="company">' + escapeHtml(m.name) + '</span>' +
                '<span style="font-size:11px;color:#555">' + (m.exchange || '') + ' ‚Ä¢ ' + (m.type || 'Stock') + '</span>' +
            '</div>' +
            '<span class="ticker">' + m.ticker + '</span>' +
        '</div>'
    ).join('');
    
    suggestionsEl.style.display = 'block';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectSuggestion(index) {
    if (index >= 0 && index < currentSuggestions.length) {
        const suggestion = currentSuggestions[index];
        document.getElementById('searchInput').value = suggestion.ticker;
        document.getElementById('suggestions').style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        analyze(suggestion.ticker);
    }
}

function updateSelectedSuggestion() {
    const items = document.querySelectorAll('.suggestion-item');
    items.forEach((item, i) => {
        item.classList.toggle('selected', i === selectedIndex);
    });
}

// Set up search input events
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('searchInput');
    
    input.addEventListener('input', function() {
        // Debounce the search
        clearTimeout(searchTimeout);
        const query = this.value;
        searchTimeout = setTimeout(() => showSuggestions(query), 300);
    });
    
    input.addEventListener('keydown', function(e) {
        const suggestionsEl = document.getElementById('suggestions');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (currentSuggestions.length > 0) {
                selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                updateSelectedSuggestion();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (currentSuggestions.length > 0) {
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelectedSuggestion();
            }
        } else if (e.key === 'Enter') {
            if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
                e.preventDefault();
                selectSuggestion(selectedIndex);
            } else {
                suggestionsEl.style.display = 'none';
                analyze();
            }
        } else if (e.key === 'Escape') {
            suggestionsEl.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box') && !e.target.closest('.suggestions')) {
            document.getElementById('suggestions').style.display = 'none';
        }
    });
    
    // Load default stocks
    loadDefaultStocks();
    // Auto-load first set of discover picks
    loadDiscover();
});

async function loadDiscover() {
    const btn = document.getElementById('discoverBtn');
    const grid = document.getElementById('discoverGrid');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Finding stocks...';
    grid.innerHTML = '<div class="discover-loading"><div class="spinner" style="width:36px;height:36px;border:3px solid #222;border-top-color:#a855f7;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div>Discovering random stocks across sectors...</div>';
    
    try {
        const resp = await fetch(API_BASE + '/api/discover');
        const data = await resp.json();
        
        if (data.picks && data.picks.length > 0) {
            displayDiscoverCards(data.picks);
        } else {
            grid.innerHTML = '<div class="discover-loading">No picks found. Try again!</div>';
        }
    } catch (e) {
        grid.innerHTML = '<div class="discover-loading">Error loading picks. Try again!</div>';
    }
    
    btn.disabled = false;
    btn.textContent = 'üîÑ Shuffle New Picks';
}

function displayDiscoverCards(picks) {
    const grid = document.getElementById('discoverGrid');
    grid.innerHTML = picks.map(function(s) {
        const scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
        const upsideClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        const arrow = (s.upside || 0) >= 0 ? '‚Üë' : '‚Üì';
        
        function mcap(n) {
            if (!n) return 'N/A';
            if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
            if (n >= 1e9) return '$' + (n/1e9).toFixed(0) + 'B';
            if (n >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
            return '$' + n;
        }
        
        return '<div class="discover-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<div class="card-top">' +
                '<div><h3>' + (s.name || s.symbol) + '</h3><span class="ticker" style="color:#888">' + s.symbol + '</span></div>' +
                '<span class="sector-tag">' + (s.sector || 'Stock') + '</span>' +
            '</div>' +
            '<div class="price-row">' +
                '<span class="price">$' + (s.price || 0).toFixed(2) + '</span>' +
                '<div class="badges">' +
                    '<span class="badge ' + upsideClass + '">' + arrow + ' ' + Math.abs(s.upside || 0).toFixed(0) + '%</span>' +
                    '<span class="badge ' + scoreClass + '">Score: ' + s.score + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="mini-stats">' +
                '<div class="mini-stat"><span>P/E</span><span class="val">' + (s.pe_ratio != null ? s.pe_ratio.toFixed(1) + 'x' : 'N/A') + '</span></div>' +
                '<div class="mini-stat"><span>Mkt Cap</span><span class="val">' + mcap(s.market_cap) + '</span></div>' +
                '<div class="mini-stat"><span>ROA</span><span class="val ' + (s.roa > 10 ? 'good' : s.roa != null && s.roa < 0 ? 'bad' : '') + '">' + (s.roa != null ? s.roa.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="mini-stat"><span>ROE</span><span class="val ' + (s.roe > 10 ? 'good' : s.roe != null && s.roe < 0 ? 'bad' : '') + '">' + (s.roe != null ? s.roe.toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '</div>' +
        '</div>';
    }).join('');
}

// Load stocks on page load
async function loadDefaultStocks() {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px"><div class="spinner" style="width:50px;height:50px;border:3px solid #222;border-top-color:#00d374;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px"></div><p style="color:#666">Loading stocks...</p></div>';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            displayStockGrid(data.opportunities);
        } else {
            grid.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>No stocks loaded yet. Try refreshing!</p></div>';
        }
    } catch (e) {
        // Retry on cold start
        setTimeout(loadDefaultStocks, 2500);
    }
}

function displayStockGrid(stocks) {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = stocks.map(function(s) {
        const scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
        const upsideClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        const arrow = (s.upside || 0) >= 0 ? '‚Üë' : '‚Üì';
        
        return '<div class="stock-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<h3>' + (s.name || s.symbol) + '</h3>' +
            '<span class="ticker">' + s.symbol + '</span>' +
            '<div class="price">$' + (s.price || 0).toFixed(2) + '</div>' +
            '<div class="badges">' +
                '<span class="badge ' + upsideClass + '">' + arrow + ' ' + Math.abs(s.upside || 0).toFixed(0) + '% upside</span>' +
                '<span class="badge ' + scoreClass + '">Score: ' + (s.score || 0) + '</span>' +
            '</div>' +
        '</div>';
    }).join('');
}

async function scanOpportunities() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'block';
    document.getElementById('detail').className = 'detail-view';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.opportunities) {
            displayStockGrid(data.opportunities);
        }
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Connection error. Please try again.');
    }
}

async function analyze(sym) {
    const rawInput = sym || document.getElementById('searchInput').value;
    if (!rawInput || !rawInput.trim()) {
        showError('Please enter a stock ticker or company name');
        return;
    }
    
    document.getElementById('suggestions').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'none';
    document.getElementById('discoverSection').style.display = 'none';
    document.getElementById('detail').className = 'detail-view';
    
    const query = rawInput.trim();
    let tickerToAnalyze = query.toUpperCase();
    
    // Check if it looks like a company name (has spaces, >5 chars, or lowercase)
    const looksLikeName = query.includes(' ') || query.length > 5 || query !== query.toUpperCase();
    
    if (looksLikeName) {
        // Search Yahoo Finance to resolve to a ticker
        setLoadingText('üîç Searching for "' + query + '"...');
        try {
            const searchResp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
            const searchData = await searchResp.json();
            if (searchData.results && searchData.results.length > 0) {
                tickerToAnalyze = searchData.results[0].symbol;
                setLoadingText('üìä Analyzing ' + searchData.results[0].name + ' (' + tickerToAnalyze + ')...');
            } else {
                setLoadingText('üìä Trying "' + tickerToAnalyze + '"...');
            }
        } catch (e) {
            // Search failed, try the raw input as ticker anyway
            setLoadingText('üìä Analyzing ' + tickerToAnalyze + '...');
        }
    } else {
        setLoadingText('üìä Analyzing ' + tickerToAnalyze + '...');
    }
    
    document.getElementById('searchInput').value = tickerToAnalyze;
    
    try {
        const resp = await fetch(API_BASE + '/api/analyze/' + encodeURIComponent(tickerToAnalyze));
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.error) {
            showError(data.error);
            document.getElementById('grid').style.display = 'block';
            return;
        }
        
        displayAnalysis(data);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Error analyzing stock. Please try again.');
        document.getElementById('grid').style.display = 'block';
    }
}

function setLoadingText(text) {
    const loadingEl = document.getElementById('loading');
    let p = loadingEl.querySelector('p');
    if (p) p.textContent = text;
}

function displayAnalysis(data) {
    if (data.is_etf) {
        displayETF(data);
    } else {
        displayStock(data);
    }
}

function fmtPct(v) { return v != null ? v.toFixed(1) + '%' : 'N/A'; }
function fmtRatio(v, d) { return v != null ? v.toFixed(d || 1) + 'x' : 'N/A'; }
function pctClass(v, good, warn) { 
    if (v == null) return ''; 
    return v > (good||10) ? 'good' : v > (warn||5) ? 'warn' : ''; 
}

function buildHeader(data) {
    const q = data.quote || {};
    const rec = data.recommendation || {};
    const price = q.price || 0;
    const upside = data.upside_percent || 0;
    const fairValue = data.fair_value || price;
    const score = data.investment_score || 0;
    const checks = data.checklist || [];
    
    const changeClass = (q.change_percent || 0) >= 0 ? 'up' : 'down';
    const changeSymbol = (q.change_percent || 0) >= 0 ? '‚Üë' : '‚Üì';
    const col = score >= 60 ? '#00d374' : (score >= 40 ? '#ffb800' : '#ff5252');
    const circ = 2 * Math.PI * 50;
    const off = circ - (score / 100) * circ;
    
    let alertHtml = '';
    if (upside > 20) {
        alertHtml = '<div class="alert"><span class="alert-icon">üíé</span><div><h3>Opportunity Detected!</h3><p>' + data.symbol + ' appears to be ' + upside.toFixed(0) + '% undervalued</p></div></div>';
    }
    
    let checklistHtml = '';
    for (let i = 0; i < checks.length; i++) {
        const c = checks[i];
        const icon = c.pass === true ? '‚úì' : (c.pass === 'warn' ? '!' : '‚úó');
        const iconClass = c.pass === true ? 'pass' : (c.pass === 'warn' ? 'warn' : 'fail');
        checklistHtml += '<li><span class="icon ' + iconClass + '">' + icon + '</span>' + c.text + '</li>';
    }
    
    const topSection = 
        '<button class="back-btn" onclick="back()">‚Üê Back to all stocks</button>' +
        alertHtml +
        '<div class="recommendation-card" style="border-left: 4px solid ' + (rec.color || '#666') + '">' +
            '<div><div class="signal" style="color: ' + (rec.color || '#fff') + '">' + (rec.signal || 'ANALYZING') + '</div>' +
            '<div class="reason">' + (rec.reason || '') + '</div></div>' +
        '</div>' +
        '<div class="header-card">' +
            '<div class="header-left">' +
                '<div class="stock-logo">' + data.symbol.slice(0,4) + '</div>' +
                '<div class="header-info"><h2>' + (q.name || data.symbol) + '</h2>' +
                '<span class="meta">' + data.symbol + ' ‚Ä¢ ' + (q.industry || q.sector || '') + '</span></div>' +
            '</div>' +
            '<div class="header-right">' +
                '<div class="current-price">$' + price.toFixed(2) + '</div>' +
                '<span class="price-change badge ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(q.change_percent || 0).toFixed(2) + '%</span>' +
            '</div>' +
        '</div>' +
        '<div class="fair-value-card">' +
            '<div><h3>üìà Calculated Upside</h3><div class="upside">' + (upside > 0 ? '+' : '') + upside.toFixed(0) + '%</div></div>' +
            '<div class="details">' +
                '<div class="detail-item"><label>Current Price</label><span>$' + price.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>Fair Value</label><span style="color:#00d374">$' + fairValue.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>52W Range</label><span>$' + (q.week_52_low || 0).toFixed(0) + ' - $' + (q.week_52_high || 0).toFixed(0) + '</span></div>' +
            '</div>' +
        '</div>';
    
    const scoreSection = 
        '<div class="card score-card"><div class="card-title">‚≠ê Investment Score</div>' +
            '<div class="score-ring">' +
                '<svg viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="50"></circle><circle cx="60" cy="60" r="50" stroke="' + col + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg>' +
                '<div class="score-text"><div class="num" style="color:' + col + '">' + score + '</div><div class="label">/100</div></div>' +
            '</div>' +
            '<ul class="checklist">' + checklistHtml + '</ul>' +
        '</div>';
    
    return { topSection, scoreSection };
}

function displayETF(data) {
    const f = data.fundamentals || {};
    const q = data.quote || {};
    const { topSection, scoreSection } = buildHeader(data);
    
    document.getElementById('detail').innerHTML = topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üìã ETF Details</div>' +
                '<div class="metric-row"><span class="label">Expense Ratio</span><span class="value ' + (f.expense_ratio != null && f.expense_ratio < 0.5 ? 'good' : '') + '">' + (f.expense_ratio != null ? f.expense_ratio.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Dividend Yield</span><span class="value ' + (f.dividend_yield > 2 ? 'good' : '') + '">' + (f.dividend_yield != null ? f.dividend_yield.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Beta</span><span class="value ' + (f.beta != null && f.beta < 1 ? 'good' : '') + '">' + (f.beta != null ? f.beta.toFixed(2) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Total Assets</span><span class="value">' + formatNum(f.total_assets) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìà Performance</div>' +
                '<div class="metric-row"><span class="label">YTD Return</span><span class="value ' + (f.ytd_return > 0 ? 'good' : f.ytd_return != null ? 'bad' : '') + '">' + (f.ytd_return != null ? f.ytd_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">3-Year Avg Return</span><span class="value ' + (f.three_yr_return > 5 ? 'good' : '') + '">' + (f.three_yr_return != null ? f.three_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">5-Year Avg Return</span><span class="value ' + (f.five_yr_return > 5 ? 'good' : '') + '">' + (f.five_yr_return != null ? f.five_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
            '</div>' +
            scoreSection +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function displayStock(data) {
    const f = data.fundamentals || {};
    const q = data.quote || {};
    const { topSection, scoreSection } = buildHeader(data);
    
    document.getElementById('detail').innerHTML = topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üí∞ Valuation</div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/S Ratio</span><span class="value ' + (f.ps_ratio != null && f.ps_ratio < 2 ? 'good' : '') + '">' + fmtRatio(f.ps_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/B Ratio</span><span class="value">' + fmtRatio(f.pb_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">Market Cap</span><span class="value">' + formatNum(q.market_cap) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìä Profitability</div>' +
                '<div class="metric-row"><span class="label">ROA</span><span class="value ' + pctClass(f.roa) + '">' + fmtPct(f.roa) + '</span></div>' +
                '<div class="metric-row"><span class="label">ROE</span><span class="value ' + pctClass(f.roe) + '">' + fmtPct(f.roe) + '</span></div>' +
                '<div class="metric-row"><span class="label">Profit Margin</span><span class="value ' + pctClass(f.profit_margin, 10, 5) + '">' + fmtPct(f.profit_margin) + '</span></div>' +
                '<div class="metric-row"><span class="label">Gross Margin</span><span class="value">' + fmtPct(f.gross_margin) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üè¶ Balance Sheet</div>' +
                '<div class="metric-row"><span class="label">Cash</span><span class="value ' + (f.cash ? 'good' : '') + '">' + formatNum(f.cash) + '</span></div>' +
                '<div class="metric-row"><span class="label">Debt</span><span class="value ' + (f.debt > f.cash ? 'bad' : '') + '">' + formatNum(f.debt) + '</span></div>' +
                '<div class="metric-row"><span class="label">Net Cash</span><span class="value ' + (f.cash >= f.debt ? 'good' : 'bad') + '">' + (f.cash != null && f.debt != null ? formatNum(f.cash - f.debt) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Free Cash Flow</span><span class="value ' + (f.fcf > 0 ? 'good' : f.fcf != null ? 'bad' : '') + '">' + formatNum(f.fcf) + '</span></div>' +
            '</div>' +
            scoreSection +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function back() {
    document.getElementById('detail').className = 'detail-view';
    document.getElementById('grid').style.display = 'block';
    document.getElementById('discoverSection').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
    setTimeout(function() { document.getElementById('error').style.display = 'none'; }, 5000);
}

function formatNum(n) {
    if (n === null || n === undefined) return 'N/A';
    if (n === 0) return '$0';
    if (Math.abs(n) >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
    if (Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}
</script>
</body>
</html>