<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Michael's Stock Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #111 100%); 
            color: #fff; min-height: 100vh; min-height: -webkit-fill-available;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overscroll-behavior-y: none;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px 12px; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 24px; }
        .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .header h1 span { background: linear-gradient(135deg, #00d374, #00a060); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #666; font-size: 13px; line-height: 1.4; }
        
        /* Search */
        .search-box { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }
        .search-input { 
            padding: 14px 16px; width: 100%; flex: 1 1 100%;
            background: #151515; border: 2px solid #222; border-radius: 12px; 
            color: #fff; font-size: 16px; transition: all 0.2s;
            min-height: 48px;
        }
        .search-input:focus { outline: none; border-color: #00d374; background: #1a1a1a; }
        .search-input::placeholder { color: #555; }
        .btn { 
            padding: 14px 20px; border: none; border-radius: 12px; 
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 48px; flex: 1 1 0;
        }
        .btn-primary { background: linear-gradient(135deg, #00d374, #00a060); color: #000; }
        .btn-primary:hover { box-shadow: 0 8px 20px rgba(0,211,116,0.3); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background: #1a1a1a; color: #fff; border: 2px solid #333; }
        .btn-secondary:hover { border-color: #00d374; }
        .btn-secondary:active { transform: scale(0.97); }
        
        /* Stock Grid */
        .section-title { color: #888; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
        .stock-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px; }
        .stock-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border: 1px solid #222; border-radius: 16px; padding: 18px; 
            cursor: pointer; transition: all 0.2s;
            -webkit-user-select: none; user-select: none;
        }
        .stock-card:active { transform: scale(0.98); background: #181818; }
        .stock-card h3 { font-size: 16px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stock-card .ticker { color: #666; font-size: 13px; font-weight: 500; }
        .stock-card .price { font-size: 24px; font-weight: 700; margin-top: 12px; }
        .stock-card .badges { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .badge { font-size: 12px; padding: 5px 10px; border-radius: 8px; font-weight: 600; }
        .badge.up { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.down { background: rgba(255,82,82,0.15); color: #ff5252; }
        .badge.score-high { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.score-medium { background: rgba(255,184,0,0.15); color: #ffb800; }
        .badge.score-low { background: rgba(255,82,82,0.15); color: #ff5252; }
        
        /* Detail View */
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .back-btn { 
            background: #1a1a1a; color: #888; border: 1px solid #333; 
            padding: 12px 20px; border-radius: 10px; cursor: pointer; 
            margin-bottom: 16px; font-size: 14px; transition: all 0.2s;
            position: sticky; top: 8px; z-index: 100; backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); min-height: 44px;
        }
        .back-btn:active { background: #252525; color: #fff; }
        
        /* Alert Banner */
        .alert { 
            background: linear-gradient(135deg, rgba(0,211,116,0.1), rgba(0,211,116,0.03)); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 14px; 
            padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;
        }
        .alert-icon { font-size: 28px; flex-shrink: 0; }
        .alert h3 { color: #00d374; font-size: 16px; margin-bottom: 2px; }
        .alert p { color: #888; font-size: 13px; }
        
        /* Header Card */
        .header-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 16px; padding: 18px; margin-bottom: 14px; 
            display: flex; flex-direction: column; gap: 14px;
        }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .stock-logo { 
            width: 52px; height: 52px; 
            background: linear-gradient(135deg, #00d374, #00a060); 
            border-radius: 14px; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 700; color: #000; flex-shrink: 0;
        }
        .header-info h2 { font-size: 18px; margin-bottom: 2px; line-height: 1.2; }
        .header-info .meta { color: #666; font-size: 12px; }
        .header-right { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; }
        .header-right .current-price { font-size: 28px; font-weight: 700; }
        .header-right .price-change { font-size: 14px; padding: 6px 12px; border-radius: 8px; display: inline-block; }
        
        /* Recommendation Card */
        .recommendation-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 14px; padding: 16px; margin-bottom: 14px;
            display: flex; align-items: center; gap: 14px;
        }
        .recommendation-card .signal { font-size: 22px; font-weight: 700; white-space: nowrap; }
        .recommendation-card .reason { color: #888; font-size: 13px; line-height: 1.4; }
        
        /* Fair Value Card */
        .fair-value-card { 
            background: linear-gradient(135deg, #0d3320, #0a1a10); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 16px; 
            padding: 18px; margin-bottom: 14px; 
            display: flex; flex-direction: column; gap: 16px;
        }
        .fair-value-card h3 { color: #00d374; font-size: 14px; margin-bottom: 4px; }
        .fair-value-card .upside { font-size: 34px; font-weight: 700; color: #00d374; }
        .fair-value-card .details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .detail-item label { display: block; color: #666; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .detail-item span { font-size: 16px; font-weight: 600; }
        
        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .card { background: linear-gradient(145deg, #151515, #111); border-radius: 14px; padding: 18px; }
        .card-title { color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; }
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1a1a1a; align-items: center; }
        .metric-row:last-child { border-bottom: none; }
        .metric-row .label { color: #888; font-size: 14px; }
        .metric-row .value { font-weight: 600; font-size: 14px; text-align: right; }
        .metric-row .value.good { color: #00d374; }
        .metric-row .value.bad { color: #ff5252; }
        .metric-row .value.warn { color: #ffb800; }
        
        /* Score Card */
        .score-card { text-align: center; }
        .score-ring { width: 120px; height: 120px; margin: 0 auto 16px; position: relative; }
        .score-ring svg { transform: rotate(-90deg); width: 120px; height: 120px; }
        .score-ring circle { fill: none; stroke-width: 10; }
        .score-ring .bg { stroke: #222; }
        .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .score-text .num { font-size: 30px; font-weight: 700; }
        .score-text .label { font-size: 11px; color: #666; }
        .checklist { list-style: none; text-align: left; margin-top: 14px; }
        .checklist li { display: flex; align-items: flex-start; gap: 10px; padding: 7px 0; font-size: 13px; line-height: 1.4; }
        .checklist .icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; margin-top: 1px; }
        .checklist .icon.pass { background: #00d374; color: #000; }
        .checklist .icon.fail { background: #ff5252; color: #fff; }
        .checklist .icon.warn { background: #ffb800; color: #000; }
        
        /* Loading & Error */
        .loading { text-align: center; padding: 60px 16px; }
        .spinner { width: 44px; height: 44px; border: 3px solid #222; border-top-color: #00d374; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: #666; font-size: 14px; }
        .error { background: rgba(255,82,82,0.1); border: 1px solid rgba(255,82,82,0.3); color: #ff5252; padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center; font-size: 14px; }
        
        /* Footer */
        footer { text-align: center; color: #333; padding: 30px 16px; font-size: 12px; }
        footer a { color: #00d374; text-decoration: none; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 16px; color: #555; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: #111; border-radius: 14px; padding: 4px; }
        .tab { flex: 1; padding: 12px 8px; text-align: center; font-size: 13px; font-weight: 600; border-radius: 10px; cursor: pointer; color: #666; transition: all 0.2s; border: none; background: none; min-height: 44px; }
        .tab.active { background: #1a1a1a; color: #fff; }
        .tab:active { transform: scale(0.97); }
        .tab-badge { background: #00d374; color: #000; font-size: 10px; padding: 1px 6px; border-radius: 10px; margin-left: 4px; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Heart / Save Button */
        .save-btn { background: none; border: 2px solid #333; border-radius: 12px; width: 48px; height: 48px; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .save-btn:active { transform: scale(0.9); }
        .save-btn.saved { border-color: #ff5252; background: rgba(255,82,82,0.1); }
        .card-save-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; z-index: 10; padding: 4px; opacity: 0.5; transition: opacity 0.2s; }
        .card-save-btn.saved { opacity: 1; }
        .stock-card, .discover-card { position: relative; }

        /* Performance Row */
        .perf-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .perf-chip { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 600; background: #1a1a1a; color: #888; }
        .perf-chip.up { color: #00d374; background: rgba(0,211,116,0.1); }
        .perf-chip.down { color: #ff5252; background: rgba(255,82,82,0.1); }
        .perf-chip .tf { color: #555; font-weight: 400; margin-right: 3px; }

        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #151515 25%, #1a1a1a 50%, #151515 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { background: #151515; border: 1px solid #222; border-radius: 16px; padding: 18px; min-height: 140px; }
        .skeleton-line { height: 14px; margin-bottom: 10px; border-radius: 6px; }
        .skeleton-line.w60 { width: 60%; }
        .skeleton-line.w40 { width: 40%; }
        .skeleton-line.w80 { width: 80%; }
        .skeleton-line.tall { height: 28px; }

        /* Watchlist Section */
        .watchlist-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .watchlist-card { background: linear-gradient(145deg, #151515, #111); border: 1px solid #222; border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; }
        .watchlist-card:active { transform: scale(0.98); }
        .watchlist-card .wl-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .watchlist-card .wl-saved-info { font-size: 11px; color: #444; margin-top: 8px; }

        /* Recommendations Section */
        .rec-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .rec-card { background: linear-gradient(145deg, #151515, #111); border: 1px solid #222; border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .rec-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #00d374, #00a060); }
        .rec-card:active { transform: scale(0.98); }
        .rec-card .reason { font-size: 12px; color: #00d374; margin-top: 8px; padding: 6px 10px; background: rgba(0,211,116,0.08); border-radius: 8px; }
        .rec-card .match-type { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        .rec-card .match-type.sector_match { background: rgba(0,211,116,0.15); color: #00d374; }
        .rec-card .match-type.diversify { background: rgba(168,85,247,0.15); color: #a855f7; }
        .rec-empty { text-align: center; padding: 50px 16px; }
        .rec-empty .icon { font-size: 48px; margin-bottom: 12px; }
        .rec-empty p { color: #555; font-size: 14px; line-height: 1.6; }
        
        /* Suggestions Dropdown */
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            width: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            margin-top: 4px;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            -webkit-overflow-scrolling: touch;
        }
        .suggestion-item {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
            transition: background 0.15s;
            min-height: 48px;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.selected { background: #252525; }
        .suggestion-item .company { color: #fff; font-weight: 500; }
        .suggestion-item .ticker { 
            background: rgba(0,211,116,0.15); 
            color: #00d374; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 600;
        }
        .search-wrapper { position: relative; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        
        /* Discover Section */
        .discover-section { margin-bottom: 28px; }
        .discover-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; gap: 12px; }
        .discover-header .section-title { margin-bottom: 0; font-size: 12px; }
        .btn-discover { 
            padding: 10px 16px; background: linear-gradient(135deg, #6c5ce7, #a855f7); 
            color: #fff; border: none; border-radius: 10px; font-size: 13px; 
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 44px; white-space: nowrap; flex-shrink: 0;
        }
        .btn-discover:active { transform: scale(0.97); }
        .btn-discover:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .discover-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .discover-card {
            background: linear-gradient(145deg, #151515, #111);
            border: 1px solid #222; border-radius: 16px; padding: 18px;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }
        .discover-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #6c5ce7, #a855f7);
        }
        .discover-card:active { transform: scale(0.98); background: #181818; }
        .discover-card .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 8px; }
        .discover-card .card-top h3 { font-size: 16px; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .discover-card .sector-tag { font-size: 10px; color: #a855f7; background: rgba(168,85,247,0.15); padding: 4px 8px; border-radius: 6px; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
        .discover-card .price-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; flex-wrap: wrap; gap: 6px; }
        .discover-card .price-row .price { font-size: 24px; font-weight: 700; }
        .discover-card .mini-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .discover-card .mini-stat { font-size: 12px; color: #888; display: flex; justify-content: space-between; padding: 4px 0; border-top: 1px solid #1a1a1a; }
        .discover-card .mini-stat .val { font-weight: 600; color: #ccc; }
        .discover-card .mini-stat .val.good { color: #00d374; }
        .discover-card .mini-stat .val.bad { color: #ff5252; }
        .discover-loading { text-align: center; padding: 30px; color: #666; font-size: 14px; }

        /* Score Points */
        .check-pts { font-size: 11px; color: #555; font-weight: 600; min-width: 28px; text-align: right; }
        .check-pts.earned { color: #00d374; }

        /* Algorithm Detail Toggle */
        .algo-toggle { cursor: pointer; padding: 14px 0 4px; text-align: center; color: #666; font-size: 13px; margin-top: 12px; border-top: 1px solid #1a1a1a; -webkit-user-select: none; user-select: none; }
        .algo-toggle:active { color: #00d374; }
        .algo-detail { padding: 16px; background: #0d0d0d; border-radius: 12px; margin-top: 12px; }
        .algo-section { margin-bottom: 16px; }
        .algo-section:last-child { margin-bottom: 0; }
        .algo-section h4 { color: #00d374; font-size: 13px; margin-bottom: 8px; font-weight: 600; }
        .algo-section p { color: #777; font-size: 12px; line-height: 1.6; margin-bottom: 6px; }
        .algo-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #111; font-size: 12px; color: #888; }
        .algo-row:last-child { border-bottom: none; }
        .algo-row .pts { color: #00d374; font-weight: 600; }
        .algo-component { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; color: #888; }
        .algo-component .val { color: #ccc; font-weight: 500; }
        .formula { font-family: 'SF Mono', Monaco, monospace; color: #aaa; font-size: 11px; background: #111; padding: 8px 12px; border-radius: 8px; margin: 6px 0; line-height: 1.5; }

        /* Rule #1 Card */
        .big5-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .big5-label { color: #888; font-size: 11px; }
        .big5-score { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 6px; }
        .big5-score.good { background: rgba(0,211,116,0.15); color: #00d374; }
        .big5-score.ok { background: rgba(255,184,0,0.15); color: #ffb800; }
        .big5-score.bad { background: rgba(255,82,82,0.15); color: #ff5252; }
        .sticker-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid #1a1a1a; }
        .sticker-verdict { text-align: center; margin-top: 10px; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 15px; }
        .moat-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #1a1a1a; }

        /* Trend Arrows */
        .trend { font-size: 10px; margin-left: 4px; font-weight: 700; vertical-align: middle; }
        .trend.up { color: #00d374; }
        .trend.down { color: #ff5252; }

        /* ========== TABLET (sm-up) ========== */
        @media (min-width: 480px) {
            .container { padding: 20px 16px; }
            .header h1 { font-size: 28px; }
            .header p { font-size: 14px; }
            .search-input { flex: 1 1 auto; }
            .btn { flex: 0 0 auto; padding: 14px 24px; }
            .stock-grid { grid-template-columns: repeat(2, 1fr); }
            .discover-grid { grid-template-columns: repeat(2, 1fr); }
            .discover-card .card-top h3 { max-width: 180px; }
            .watchlist-grid { grid-template-columns: repeat(2, 1fr); }
            .rec-grid { grid-template-columns: repeat(2, 1fr); }
            .tab { font-size: 13px; }
        }

        /* ========== DESKTOP (md-up) ========== */
        @media (min-width: 768px) {
            .container { padding: 30px 24px; }
            .header { margin-bottom: 36px; }
            .header h1 { font-size: 34px; }
            .header p { font-size: 16px; }
            .search-box { margin-bottom: 36px; }
            .search-input { font-size: 18px; padding: 16px 24px; max-width: 420px; }
            .btn { font-size: 16px; padding: 16px 32px; }
            .section-title { font-size: 14px; margin-bottom: 20px; }
            .stock-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
            .stock-card { padding: 24px; border-radius: 20px; }
            .stock-card h3 { font-size: 18px; }
            .stock-card .price { font-size: 28px; margin-top: 16px; }
            .badge { font-size: 13px; padding: 6px 12px; }
            .discover-section { margin-bottom: 40px; }
            .discover-header .section-title { font-size: 14px; }
            .discover-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .discover-card { padding: 24px; border-radius: 20px; }
            .discover-card .card-top h3 { font-size: 18px; max-width: 200px; }
            .discover-card .price-row .price { font-size: 28px; }
            .watchlist-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
            .rec-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .tabs { max-width: 500px; margin-left: auto; margin-right: auto; margin-bottom: 28px; }
            .tab { font-size: 14px; padding: 14px 12px; }
            .header-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 28px; border-radius: 20px; }
            .stock-logo { width: 70px; height: 70px; font-size: 18px; }
            .header-info h2 { font-size: 24px; }
            .header-info .meta { font-size: 14px; }
            .header-right .current-price { font-size: 36px; }
            .header-right .price-change { font-size: 16px; padding: 8px 16px; }
            .recommendation-card { padding: 24px; gap: 20px; border-radius: 16px; }
            .recommendation-card .signal { font-size: 28px; }
            .recommendation-card .reason { font-size: 15px; }
            .fair-value-card { flex-direction: row; justify-content: space-between; align-items: center; padding: 28px; border-radius: 20px; }
            .fair-value-card .upside { font-size: 42px; }
            .fair-value-card .details { gap: 40px; }
            .detail-item label { font-size: 12px; }
            .detail-item span { font-size: 22px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
            .card { padding: 24px; border-radius: 16px; }
            .card-title { font-size: 13px; margin-bottom: 20px; }
            .metric-row { padding: 12px 0; }
            .metric-row .label { font-size: 15px; }
            .metric-row .value { font-size: 15px; }
            .score-ring { width: 140px; height: 140px; }
            .score-ring svg { width: 140px; height: 140px; }
            .score-text .num { font-size: 36px; }
            .back-btn { position: relative; top: auto; backdrop-filter: none; margin-bottom: 24px; }
            .back-btn:hover { color: #fff; border-color: #444; }
            .btn-primary:hover { transform: translateY(-2px); }
            .stock-card:hover { border-color: #00d374; transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
            .discover-card:hover { border-color: #a855f7; transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
            .btn-discover:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(168,85,247,0.3); }
            .suggestions { left: 50%; right: auto; transform: translateX(-50%); width: 420px; max-height: 300px; }
            .loading { padding: 80px 20px; }
            .loading p { font-size: 16px; }
            .error { padding: 20px; margin-bottom: 20px; }
            footer { padding: 40px 20px; font-size: 13px; }
            .empty-state { padding: 60px 20px; }
            .empty-state .icon { font-size: 48px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà <span>Michael's Stock Analyzer</span></h1>
            <p>Smart investment analysis ‚Ä¢ ROA/ROE &gt;10% ‚Ä¢ Cash vs Debt ‚Ä¢ Fair Value</p>
        </div>
        
        <div class="search-box" style="position: relative;">
            <input type="text" class="search-input" id="searchInput" placeholder="Ticker or company (e.g. Apple, TSLA)" autocomplete="off" enterkeyhint="search">
            <button class="btn btn-primary" onclick="analyze()">üîç Analyze</button>
            <div id="suggestions" class="suggestions"></div>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Analyzing stocks...</p>
        </div>

        <!-- Tabs -->
        <div id="mainTabs" class="tabs">
            <button class="tab active" onclick="switchTab('market')">üìä Market</button>
            <button class="tab" onclick="switchTab('watchlist')">‚ù§Ô∏è Saved <span id="wlCount" class="tab-badge" style="display:none">0</span></button>
            <button class="tab" onclick="switchTab('foryou')">üéØ For You</button>
        </div>

        <!-- Market Tab -->
        <div id="tabMarket" class="tab-content active">
            <div id="discoverSection" class="discover-section">
                <div class="discover-header">
                    <div class="section-title">üé≤ Discover Random Stocks</div>
                    <button class="btn-discover" id="discoverBtn" onclick="loadDiscover()">üîÑ Shuffle New Picks</button>
                </div>
                <div id="discoverGrid" class="discover-grid">
                    <div class="discover-loading">Click "Shuffle New Picks" to discover stocks!</div>
                </div>
            </div>
            
            <div id="grid">
                <div class="section-title">üìä Top Stocks to Analyze</div>
                <div class="stock-grid" id="stockGrid"></div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="tabWatchlist" class="tab-content">
            <div class="section-title">‚ù§Ô∏è Your Saved Stocks</div>
            <div id="watchlistGrid" class="watchlist-grid">
                <div class="empty-state"><div class="icon">üí°</div><p>No saved stocks yet. Analyze a stock and tap ‚ù§Ô∏è to save it!</p></div>
            </div>
        </div>

        <!-- For You Tab -->
        <div id="tabForyou" class="tab-content">
            <div class="section-title">üéØ Recommended For You</div>
            <div id="profileSummary" style="margin-bottom:14px"></div>
            <div id="recGrid" class="rec-grid">
                <div class="rec-empty"><div class="icon">ü§ñ</div><p>Save some stocks first!<br>We'll analyze your preferences and find similar opportunities.</p></div>
            </div>
        </div>
        
        <div id="detail" class="detail-view"></div>
        
        <footer>
            Built with ‚ù§Ô∏è for Michael
        </footer>
    </div>

<script>
const API_BASE = window.location.origin;
const SUPABASE_URL = 'https://uhmoslyaavuswzlqeyml.supabase.co';
const SUPABASE_KEY = 'sb_publishable_WZHHhv_faBOJltSJG_IK_w_VMgGqFGO';

// Watchlist state (in-memory cache)
let watchlistMap = {}; // symbol -> row data
let currentStockData = null; // currently displayed stock

// ========== SUPABASE / WATCHLIST ==========
async function loadWatchlist() {
    try {
        const resp = await fetch(API_BASE + '/api/watchlist');
        const data = await resp.json();
        watchlistMap = {};
        (data.watchlist || []).forEach(function(item) {
            watchlistMap[item.symbol] = item;
        });
        updateWatchlistBadge();
    } catch (e) {
        console.error('Watchlist load error:', e);
    }
}

function updateWatchlistBadge() {
    const count = Object.keys(watchlistMap).length;
    const badge = document.getElementById('wlCount');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

function isInWatchlist(symbol) {
    return !!watchlistMap[symbol];
}

async function toggleWatchlist(symbol, name, sector, industry, score, price) {
    if (isInWatchlist(symbol)) {
        // Remove
        try {
            await fetch(API_BASE + '/api/watchlist?symbol=' + symbol, { method: 'DELETE' });
            delete watchlistMap[symbol];
        } catch (e) { console.error(e); }
    } else {
        // Add
        try {
            const resp = await fetch(API_BASE + '/api/watchlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol, name, sector, industry, score, price })
            });
            const data = await resp.json();
            if (data.success && data.item) {
                watchlistMap[symbol] = data.item;
            } else if (data.error === 'Already in watchlist') {
                watchlistMap[symbol] = { symbol, name };
            }
        } catch (e) { console.error(e); }
    }
    updateWatchlistBadge();
    updateAllHeartButtons(symbol);
}

function updateAllHeartButtons(symbol) {
    const saved = isInWatchlist(symbol);
    document.querySelectorAll('[data-heart="' + symbol + '"]').forEach(function(btn) {
        btn.textContent = saved ? '‚ù§Ô∏è' : 'ü§ç';
        btn.className = saved ? btn.className.replace('saved', '') + ' saved' : btn.className.replace(' saved', '');
    });
}

// ========== TABS ==========
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    
    var idx = { market: 0, watchlist: 1, foryou: 2 }[tabName] || 0;
    document.querySelectorAll('.tab')[idx].classList.add('active');
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    
    // Hide detail view when switching tabs
    document.getElementById('detail').className = 'detail-view';
    
    if (tabName === 'watchlist') loadWatchlistView();
    if (tabName === 'foryou') loadRecommendations();
}

// ========== WATCHLIST VIEW ==========
async function loadWatchlistView() {
    const grid = document.getElementById('watchlistGrid');
    const symbols = Object.keys(watchlistMap);
    
    if (symbols.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">üí°</div><p>No saved stocks yet.<br>Analyze a stock and tap ‚ù§Ô∏è to save it!</p></div>';
        return;
    }
    
    // Show skeleton while loading live data
    grid.innerHTML = symbols.map(function() {
        return '<div class="skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div><div class="skeleton skeleton-line tall w80"></div></div>';
    }).join('');
    
    // Fetch live data for all saved stocks
    try {
        const resp = await fetch(API_BASE + '/api/scan?symbols=' + symbols.join(','));
        const data = await resp.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            grid.innerHTML = data.opportunities.map(function(s) {
                const wlItem = watchlistMap[s.symbol] || {};
                const savedPrice = wlItem.price_at_save;
                const gainPct = savedPrice && savedPrice > 0 ? ((s.price - savedPrice) / savedPrice * 100) : null;
                const scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
                
                return '<div class="watchlist-card" onclick="analyze(\'' + s.symbol + '\')">' +
                    '<button class="card-save-btn saved" data-heart="' + s.symbol + '" onclick="event.stopPropagation();toggleWatchlist(\'' + s.symbol + '\',\'' + escapeAttr(s.name) + '\')">‚ù§Ô∏è</button>' +
                    '<div class="wl-top">' +
                        '<div><h3 style="font-size:16px;margin-bottom:2px">' + (s.name || s.symbol) + '</h3><span style="color:#666;font-size:13px">' + s.symbol + '</span></div>' +
                        '<div style="text-align:right"><div style="font-size:22px;font-weight:700">$' + s.price.toFixed(2) + '</div>' +
                        '<span class="badge ' + scoreClass + '">Score: ' + s.score + '</span></div>' +
                    '</div>' +
                    (gainPct !== null ? '<div class="wl-saved-info">Since saved: <span style="color:' + (gainPct >= 0 ? '#00d374' : '#ff5252') + ';font-weight:600">' + (gainPct >= 0 ? '+' : '') + gainPct.toFixed(1) + '%</span> (from $' + savedPrice.toFixed(2) + ')</div>' : '') +
                '</div>';
            }).join('');
        } else {
            // Show cached data without live prices
            grid.innerHTML = symbols.map(function(sym) {
                var w = watchlistMap[sym];
                return '<div class="watchlist-card" onclick="analyze(\'' + sym + '\')">' +
                    '<h3>' + (w.name || sym) + '</h3><span style="color:#666">' + sym + '</span>' +
                '</div>';
            }).join('');
        }
    } catch (e) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">‚ö†Ô∏è</div><p>Error loading live data. <button class="btn btn-secondary" style="margin-top:8px" onclick="loadWatchlistView()">Retry</button></p></div>';
    }
}

// ========== RECOMMENDATIONS ==========
async function loadRecommendations() {
    const grid = document.getElementById('recGrid');
    const summary = document.getElementById('profileSummary');
    
    if (Object.keys(watchlistMap).length === 0) {
        grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">ü§ñ</div><p>Save some stocks first!<br>We\'ll analyze your preferences and find similar opportunities.</p></div>';
        summary.innerHTML = '';
        return;
    }
    
    // Show skeleton
    grid.innerHTML = '';
    for (var i = 0; i < 6; i++) {
        grid.innerHTML += '<div class="skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div><div class="skeleton skeleton-line tall w80"></div><div class="skeleton skeleton-line w60"></div></div>';
    }
    summary.innerHTML = '<div style="color:#666;font-size:13px;text-align:center"><div class="spinner" style="width:24px;height:24px;border:2px solid #222;border-top-color:#00d374;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 8px"></div>Analyzing your ' + Object.keys(watchlistMap).length + ' saved stocks and finding matches...</div>';
    
    try {
        const resp = await fetch(API_BASE + '/api/recommend');
        const data = await resp.json();
        
        if (data.profile) {
            summary.innerHTML = '<div style="background:#111;border-radius:12px;padding:14px;margin-bottom:4px">' +
                '<div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;font-size:12px;color:#888">' +
                    '<span>üìä Tracking <strong style="color:#fff">' + data.profile.watchlist_count + '</strong> stocks</span>' +
                    '<span>üéØ Avg Score <strong style="color:#fff">' + data.profile.avg_score + '</strong></span>' +
                    '<span>üè∑ Top: <strong style="color:#fff">' + data.profile.top_sectors.join(', ') + '</strong></span>' +
                '</div></div>';
        }
        
        if (data.recommendations && data.recommendations.length > 0) {
            grid.innerHTML = data.recommendations.map(function(r) {
                var scoreClass = r.score >= 60 ? 'score-high' : r.score >= 40 ? 'score-medium' : 'score-low';
                var upsideClass = r.upside >= 0 ? 'up' : 'down';
                var matchLabel = r.match_type === 'sector_match' ? 'üéØ Sector Match' : 'üåà Diversify';
                
                return '<div class="rec-card" onclick="analyze(\'' + r.symbol + '\')">' +
                    '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">' +
                        '<div><h3 style="font-size:16px;margin-bottom:2px">' + (r.name || r.symbol) + '</h3>' +
                        '<span style="color:#666;font-size:13px">' + r.symbol + ' ‚Ä¢ ' + (r.sector || '') + '</span></div>' +
                        '<span class="match-type ' + r.match_type + '">' + matchLabel + '</span>' +
                    '</div>' +
                    '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px">' +
                        '<span style="font-size:22px;font-weight:700">$' + r.price.toFixed(2) + '</span>' +
                        '<div class="badges"><span class="badge ' + upsideClass + '">' + (r.upside >= 0 ? '‚Üë' : '‚Üì') + ' ' + Math.abs(r.upside).toFixed(0) + '%</span><span class="badge ' + scoreClass + '">Score: ' + r.score + '</span></div>' +
                    '</div>' +
                    '<div class="reason">' + r.reason + '</div>' +
                '</div>';
            }).join('');
        } else if (data.message) {
            grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">ü§ñ</div><p>' + data.message + '</p></div>';
        }
    } catch (e) {
        grid.innerHTML = '<div class="rec-empty" style="grid-column:1/-1"><div class="icon">‚ö†Ô∏è</div><p>Error loading recommendations. <button class="btn btn-secondary" style="margin-top:8px" onclick="loadRecommendations()">Retry</button></p></div>';
        summary.innerHTML = '';
    }
}

// ========== SEARCH ==========
let selectedIndex = -1;
let currentSuggestions = [];
let searchTimeout = null;

async function searchStocks(query) {
    if (!query || query.length < 1) return [];
    try {
        const resp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
        const data = await resp.json();
        return data.results || [];
    } catch (e) {
        return [];
    }
}

async function showSuggestions(query) {
    const suggestionsEl = document.getElementById('suggestions');
    if (!query || query.length < 1) {
        suggestionsEl.style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        return;
    }
    suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#666">üîç Searching...</span></div>';
    suggestionsEl.style.display = 'block';
    const results = await searchStocks(query);
    currentSuggestions = results.map(function(r) { return { name: r.name, ticker: r.symbol, exchange: r.exchange, type: r.type }; });
    selectedIndex = -1;
    if (currentSuggestions.length === 0) {
        suggestionsEl.innerHTML = '<div class="suggestion-item"><span class="company" style="color:#888">No results. Press Enter to search "' + query.toUpperCase() + '"</span></div>';
        return;
    }
    suggestionsEl.innerHTML = currentSuggestions.map(function(m, i) {
        return '<div class="suggestion-item" data-index="' + i + '" onclick="selectSuggestion(' + i + ')">' +
            '<div style="display:flex;flex-direction:column;gap:2px"><span class="company">' + escapeHtml(m.name) + '</span>' +
            '<span style="font-size:11px;color:#555">' + (m.exchange || '') + ' ‚Ä¢ ' + (m.type || 'Stock') + '</span></div>' +
            '<span class="ticker">' + m.ticker + '</span></div>';
    }).join('');
    suggestionsEl.style.display = 'block';
}

function escapeHtml(text) { var d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function escapeAttr(text) { return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function selectSuggestion(index) {
    if (index >= 0 && index < currentSuggestions.length) {
        var s = currentSuggestions[index];
        document.getElementById('searchInput').value = s.ticker;
        document.getElementById('suggestions').style.display = 'none';
        currentSuggestions = [];
        selectedIndex = -1;
        analyze(s.ticker);
    }
}

function updateSelectedSuggestion() {
    document.querySelectorAll('.suggestion-item').forEach(function(item, i) {
        item.classList.toggle('selected', i === selectedIndex);
    });
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('searchInput');
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        var q = this.value;
        searchTimeout = setTimeout(function() { showSuggestions(q); }, 300);
    });
    input.addEventListener('keydown', function(e) {
        var suggestionsEl = document.getElementById('suggestions');
        if (e.key === 'ArrowDown') { e.preventDefault(); if (currentSuggestions.length > 0) { selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1); updateSelectedSuggestion(); } }
        else if (e.key === 'ArrowUp') { e.preventDefault(); if (currentSuggestions.length > 0) { selectedIndex = Math.max(selectedIndex - 1, -1); updateSelectedSuggestion(); } }
        else if (e.key === 'Enter') { if (selectedIndex >= 0) { e.preventDefault(); selectSuggestion(selectedIndex); } else { suggestionsEl.style.display = 'none'; analyze(); } }
        else if (e.key === 'Escape') { suggestionsEl.style.display = 'none'; selectedIndex = -1; }
    });
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box') && !e.target.closest('.suggestions')) document.getElementById('suggestions').style.display = 'none';
    });
    
    loadWatchlist();
    loadDefaultStocks();
    loadDiscover();
});

// ========== DISCOVER ==========
async function loadDiscover() {
    var btn = document.getElementById('discoverBtn');
    var grid = document.getElementById('discoverGrid');
    btn.disabled = true;
    btn.textContent = '‚è≥ Finding stocks...';
    grid.innerHTML = '<div class="discover-loading"><div class="spinner" style="width:36px;height:36px;border:3px solid #222;border-top-color:#a855f7;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px"></div>Discovering random stocks across sectors...</div>';
    try {
        var resp = await fetch(API_BASE + '/api/discover');
        var data = await resp.json();
        if (data.picks && data.picks.length > 0) displayDiscoverCards(data.picks);
        else grid.innerHTML = '<div class="discover-loading">No picks found. Try again!</div>';
    } catch (e) {
        grid.innerHTML = '<div class="discover-loading">Error loading picks. Try again!</div>';
    }
    btn.disabled = false;
    btn.textContent = 'üîÑ Shuffle New Picks';
}

function displayDiscoverCards(picks) {
    var grid = document.getElementById('discoverGrid');
    grid.innerHTML = picks.map(function(s) {
        var scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
        var upsideClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        var arrow = (s.upside || 0) >= 0 ? '‚Üë' : '‚Üì';
        function mcap(n) { if (!n) return 'N/A'; if (n >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T'; if (n >= 1e9) return '$' + (n/1e9).toFixed(0) + 'B'; if (n >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M'; return '$' + n; }
        var heartClass = isInWatchlist(s.symbol) ? 'card-save-btn saved' : 'card-save-btn';
        var heartIcon = isInWatchlist(s.symbol) ? '‚ù§Ô∏è' : 'ü§ç';
        return '<div class="discover-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<button class="' + heartClass + '" data-heart="' + s.symbol + '" onclick="event.stopPropagation();toggleWatchlist(\'' + s.symbol + '\',\'' + escapeAttr(s.name) + '\',\'' + escapeAttr(s.sector) + '\',\'\','+s.score+','+(s.price||0)+')">' + heartIcon + '</button>' +
            '<div class="card-top"><div><h3>' + (s.name || s.symbol) + '</h3><span class="ticker" style="color:#888">' + s.symbol + '</span></div>' +
            '<span class="sector-tag">' + (s.sector || 'Stock') + '</span></div>' +
            '<div class="price-row"><span class="price">$' + (s.price || 0).toFixed(2) + '</span>' +
            '<div class="badges"><span class="badge ' + upsideClass + '">' + arrow + ' ' + Math.abs(s.upside || 0).toFixed(0) + '%</span><span class="badge ' + scoreClass + '">Score: ' + s.score + '</span></div></div>' +
            '<div class="mini-stats">' +
            '<div class="mini-stat"><span>P/E</span><span class="val">' + (s.pe_ratio != null ? s.pe_ratio.toFixed(1) + 'x' : 'N/A') + '</span></div>' +
            '<div class="mini-stat"><span>Mkt Cap</span><span class="val">' + mcap(s.market_cap) + '</span></div>' +
            '<div class="mini-stat"><span>ROA</span><span class="val ' + (s.roa > 10 ? 'good' : s.roa != null && s.roa < 0 ? 'bad' : '') + '">' + (s.roa != null ? s.roa.toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '<div class="mini-stat"><span>ROE</span><span class="val ' + (s.roe > 10 ? 'good' : s.roe != null && s.roe < 0 ? 'bad' : '') + '">' + (s.roe != null ? s.roe.toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '</div></div>';
    }).join('');
}

// ========== STOCK GRID ==========
async function loadDefaultStocks() {
    var grid = document.getElementById('stockGrid');
    // Skeleton loading
    grid.innerHTML = '';
    for (var i = 0; i < 10; i++) {
        grid.innerHTML += '<div class="skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div><div class="skeleton skeleton-line tall w80"></div><div class="skeleton skeleton-line w60"></div></div>';
    }
    try {
        var resp = await fetch(API_BASE + '/api/scan');
        var data = await resp.json();
        if (data.opportunities && data.opportunities.length > 0) displayStockGrid(data.opportunities);
        else grid.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>No stocks loaded yet. Try refreshing!</p></div>';
    } catch (e) {
        setTimeout(loadDefaultStocks, 2500);
    }
}

function displayStockGrid(stocks) {
    var grid = document.getElementById('stockGrid');
    grid.innerHTML = stocks.map(function(s) {
        var scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
        var upsideClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        var arrow = (s.upside || 0) >= 0 ? '‚Üë' : '‚Üì';
        var heartClass = isInWatchlist(s.symbol) ? 'card-save-btn saved' : 'card-save-btn';
        var heartIcon = isInWatchlist(s.symbol) ? '‚ù§Ô∏è' : 'ü§ç';
        return '<div class="stock-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<button class="' + heartClass + '" data-heart="' + s.symbol + '" onclick="event.stopPropagation();toggleWatchlist(\'' + s.symbol + '\',\'' + escapeAttr(s.name) + '\',\'\',\'\','+s.score+','+(s.price||0)+')">' + heartIcon + '</button>' +
            '<h3>' + (s.name || s.symbol) + '</h3><span class="ticker">' + s.symbol + '</span>' +
            '<div class="price">$' + (s.price || 0).toFixed(2) + '</div>' +
            '<div class="badges"><span class="badge ' + upsideClass + '">' + arrow + ' ' + Math.abs(s.upside || 0).toFixed(0) + '% upside</span><span class="badge ' + scoreClass + '">Score: ' + (s.score || 0) + '</span></div>' +
        '</div>';
    }).join('');
}

async function scanOpportunities() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    switchTab('market');
    try {
        var resp = await fetch(API_BASE + '/api/scan');
        var data = await resp.json();
        document.getElementById('loading').style.display = 'none';
        if (data.opportunities) displayStockGrid(data.opportunities);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Connection error. Please try again.');
    }
}

// ========== ANALYZE ==========
async function analyze(sym) {
    var rawInput = sym || document.getElementById('searchInput').value;
    if (!rawInput || !rawInput.trim()) { showError('Please enter a stock ticker or company name'); return; }
    
    document.getElementById('suggestions').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('mainTabs').style.display = 'none';
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('detail').className = 'detail-view';
    
    var query = rawInput.trim();
    var tickerToAnalyze = query.toUpperCase();
    var looksLikeName = query.includes(' ') || query.length > 5 || query !== query.toUpperCase();
    
    if (looksLikeName) {
        setLoadingText('üîç Searching for "' + query + '"...');
        try {
            var searchResp = await fetch(API_BASE + '/api/search/' + encodeURIComponent(query));
            var searchData = await searchResp.json();
            if (searchData.results && searchData.results.length > 0) {
                tickerToAnalyze = searchData.results[0].symbol;
                setLoadingText('üìä Analyzing ' + searchData.results[0].name + ' (' + tickerToAnalyze + ')...');
            }
        } catch (e) {}
    } else {
        setLoadingText('üìä Analyzing ' + tickerToAnalyze + '...');
    }
    
    document.getElementById('searchInput').value = tickerToAnalyze;
    
    try {
        var resp = await fetch(API_BASE + '/api/analyze/' + encodeURIComponent(tickerToAnalyze));
        var data = await resp.json();
        document.getElementById('loading').style.display = 'none';
        if (data.error) { showError(data.error); back(); return; }
        currentStockData = data;
        displayAnalysis(data);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Error analyzing stock. Please try again.');
        back();
    }
}

function setLoadingText(text) {
    var p = document.getElementById('loading').querySelector('p');
    if (p) p.textContent = text;
}

function displayAnalysis(data) {
    if (data.is_etf) displayETF(data);
    else displayStock(data);
}

// ========== HELPERS ==========
function fmtPct(v) { return v != null ? v.toFixed(1) + '%' : 'N/A'; }
function fmtRatio(v, d) { return v != null ? v.toFixed(d || 1) + 'x' : 'N/A'; }
function pctClass(v, good, warn) { if (v == null) return ''; return v > (good||10) ? 'good' : v > (warn||5) ? 'warn' : ''; }

function buildHeader(data) {
    var q = data.quote || {};
    var rec = data.recommendation || {};
    var price = q.price || 0;
    var upside = data.upside_percent || 0;
    var fairValue = data.fair_value || price;
    var score = data.investment_score || 0;
    var checks = data.checklist || [];
    
    var changeClass = (q.change_percent || 0) >= 0 ? 'up' : 'down';
    var changeSymbol = (q.change_percent || 0) >= 0 ? '‚Üë' : '‚Üì';
    var col = score >= 60 ? '#00d374' : (score >= 40 ? '#ffb800' : '#ff5252');
    var circ = 2 * Math.PI * 50;
    var off = circ - (score / 100) * circ;
    
    var saved = isInWatchlist(data.symbol);
    var heartHtml = '<button class="save-btn' + (saved ? ' saved' : '') + '" data-heart="' + data.symbol + '" onclick="toggleWatchlist(\'' + data.symbol + '\',\'' + escapeAttr(q.name) + '\',\'' + escapeAttr(q.sector) + '\',\'' + escapeAttr(q.industry) + '\',' + score + ',' + price + ')">' + (saved ? '‚ù§Ô∏è' : 'ü§ç') + '</button>';
    
    var alertHtml = '';
    if (upside > 20) {
        alertHtml = '<div class="alert"><span class="alert-icon">üíé</span><div><h3>Opportunity Detected!</h3><p>' + data.symbol + ' appears to be ' + upside.toFixed(0) + '% undervalued</p></div></div>';
    }
    
    var checklistHtml = '';
    for (var i = 0; i < checks.length; i++) {
        var c = checks[i];
        var icon = c.pass === true ? '‚úì' : (c.pass === 'warn' ? '!' : '‚úó');
        var iconClass = c.pass === true ? 'pass' : (c.pass === 'warn' ? 'warn' : 'fail');
        var ptsText = c.points != null ? (c.points > 0 ? '+' + c.points : '0') : '';
        var ptsClass = c.points > 0 ? 'check-pts earned' : 'check-pts';
        checklistHtml += '<li><span class="icon ' + iconClass + '">' + icon + '</span><span style="flex:1">' + c.text + '</span>' + (ptsText !== '' ? '<span class="' + ptsClass + '">' + ptsText + '</span>' : '') + '</li>';
    }
    
    var topSection = 
        '<button class="back-btn" onclick="back()">‚Üê Back to all stocks</button>' +
        alertHtml +
        '<div class="recommendation-card" style="border-left: 4px solid ' + (rec.color || '#666') + '">' +
            '<div><div class="signal" style="color: ' + (rec.color || '#fff') + '">' + (rec.signal || 'ANALYZING') + '</div>' +
            '<div class="reason">' + (rec.reason || '') + '</div></div>' +
        '</div>' +
        '<div class="header-card">' +
            '<div class="header-left">' +
                '<div class="stock-logo">' + data.symbol.slice(0,4) + '</div>' +
                '<div class="header-info"><h2>' + (q.name || data.symbol) + '</h2>' +
                '<span class="meta">' + data.symbol + ' ‚Ä¢ ' + (q.industry || q.sector || '') + '</span></div>' +
            '</div>' +
            '<div class="header-right" style="display:flex;align-items:center;gap:12px">' +
                '<div>' +
                    '<div class="current-price">$' + price.toFixed(2) + '</div>' +
                    '<span class="price-change badge ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(q.change_percent || 0).toFixed(2) + '% today</span>' +
                '</div>' +
                heartHtml +
            '</div>' +
        '</div>' +
        '<div id="perfRow" class="perf-row" style="margin-bottom:14px"><div class="perf-chip"><span class="tf">Loading performance...</span></div></div>' +
        '<div class="fair-value-card">' +
            '<div><h3>üìà Calculated Upside</h3><div class="upside">' + (upside > 0 ? '+' : '') + upside.toFixed(0) + '%</div></div>' +
            '<div class="details">' +
                '<div class="detail-item"><label>Current Price</label><span>$' + price.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>Fair Value</label><span style="color:#00d374">$' + fairValue.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>52W Range</label><span>$' + (q.week_52_low || 0).toFixed(0) + ' - $' + (q.week_52_high || 0).toFixed(0) + '</span></div>' +
            '</div>' +
        '</div>';
    
    var scoreSection = 
        '<div class="card score-card"><div class="card-title">‚≠ê Investment Score</div>' +
            '<div class="score-ring">' +
                '<svg viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="50"></circle><circle cx="60" cy="60" r="50" stroke="' + col + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg>' +
                '<div class="score-text"><div class="num" style="color:' + col + '">' + score + '</div><div class="label">/100</div></div>' +
            '</div>' +
            '<ul class="checklist">' + checklistHtml + '</ul>' +
        '</div>';
    
    return { topSection: topSection, scoreSection: scoreSection };
}

// ========== PERFORMANCE ==========
async function loadPerformance(symbol) {
    var row = document.getElementById('perfRow');
    if (!row) return;
    try {
        var resp = await fetch(API_BASE + '/api/performance/' + symbol);
        var data = await resp.json();
        if (data.timeframes) {
            var tf = data.timeframes;
            var html = '';
            var labels = ['1D', '1W', '1M', '3M', '6M', '1Y'];
            for (var i = 0; i < labels.length; i++) {
                var key = labels[i];
                var val = tf[key];
                if (val != null) {
                    var cls = val >= 0 ? 'up' : 'down';
                    html += '<div class="perf-chip ' + cls + '"><span class="tf">' + key + '</span>' + (val >= 0 ? '+' : '') + val.toFixed(1) + '%</div>';
                }
            }
            if (data.off_high_pct != null) {
                html += '<div class="perf-chip ' + (data.off_high_pct >= 0 ? 'up' : 'down') + '"><span class="tf">vs 52W High</span>' + data.off_high_pct.toFixed(1) + '%</div>';
            }
            row.innerHTML = html || '<div class="perf-chip">No performance data</div>';
        }
    } catch (e) {
        row.innerHTML = '<div class="perf-chip">Performance unavailable</div>';
    }
}

// ========== DISPLAY STOCK ==========
function displayETF(data) {
    var f = data.fundamentals || {};
    var q = data.quote || {};
    var r = buildHeader(data);
    
    document.getElementById('detail').innerHTML = r.topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üìã ETF Details</div>' +
                '<div class="metric-row"><span class="label">Expense Ratio</span><span class="value ' + (f.expense_ratio != null && f.expense_ratio < 0.5 ? 'good' : '') + '">' + (f.expense_ratio != null ? f.expense_ratio.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Dividend Yield</span><span class="value ' + (f.dividend_yield > 2 ? 'good' : '') + '">' + (f.dividend_yield != null ? f.dividend_yield.toFixed(2) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Beta</span><span class="value ' + (f.beta != null && f.beta < 1 ? 'good' : '') + '">' + (f.beta != null ? f.beta.toFixed(2) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Total Assets</span><span class="value">' + formatNum(f.total_assets) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìà Performance</div>' +
                '<div class="metric-row"><span class="label">YTD Return</span><span class="value ' + (f.ytd_return > 0 ? 'good' : f.ytd_return != null ? 'bad' : '') + '">' + (f.ytd_return != null ? f.ytd_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">3-Year Avg Return</span><span class="value ' + (f.three_yr_return > 5 ? 'good' : '') + '">' + (f.three_yr_return != null ? f.three_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">5-Year Avg Return</span><span class="value ' + (f.five_yr_return > 5 ? 'good' : '') + '">' + (f.five_yr_return != null ? f.five_yr_return.toFixed(1) + '%' : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
            '</div>' +
            r.scoreSection +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    loadPerformance(data.symbol);
}

function displayStock(data) {
    var f = data.fundamentals || {};
    var q = data.quote || {};
    var g = data.growth || {};
    var r1 = data.rule1 || {};
    var fvComps = data.fair_value_components || [];
    var r = buildHeader(data);
    
    function trend(dir) {
        if (dir === 'up') return '<span class="trend up">‚ñ≤</span>';
        if (dir === 'down') return '<span class="trend down">‚ñº</span>';
        return '';
    }
    
    // Rule #1 card
    var rule1Html = '';
    if (r1.big5) {
        var big5Rows = '';
        for (var i = 0; i < r1.big5.length; i++) {
            var m = r1.big5[i];
            var val = m.value != null ? m.value.toFixed(1) + m.unit : 'N/A';
            var cls = m.pass ? 'good' : (m.value != null && m.value < 0 ? 'bad' : '');
            var ico = m.pass ? ' ‚úì' : (m.value != null ? ' ‚úó' : '');
            var note = m.note ? ' <span style="color:#555;font-size:10px">(' + m.note + ')</span>' : '';
            big5Rows += '<div class="metric-row"><span class="label">' + m.name + note + '</span><span class="value ' + cls + '">' + val + ico + '</span></div>';
        }
        var b5cls = r1.big5_passing >= 4 ? 'good' : (r1.big5_passing >= 2 ? 'ok' : 'bad');
        
        var stickerHtml = '';
        if (r1.sticker) {
            var s = r1.sticker;
            stickerHtml = '<div class="sticker-section">' +
                '<div class="card-title">üí∞ Sticker Price (Phil Town)</div>' +
                '<div class="metric-row"><span class="label">Growth Rate</span><span class="value">' + s.growth_rate + '% <span style="color:#555;font-size:10px">(' + s.growth_source + ')</span></span></div>' +
                '<div class="metric-row"><span class="label">Sticker Price</span><span class="value">$' + s.sticker_price.toFixed(2) + '</span></div>' +
                '<div class="metric-row"><span class="label">MOS Price (50% off)</span><span class="value" style="color:#00d374">$' + s.mos_price.toFixed(2) + '</span></div>' +
                '<div class="metric-row"><span class="label">Current Price</span><span class="value">$' + s.current_price.toFixed(2) + '</span></div>' +
                '<div class="sticker-verdict" style="background:' + s.verdict_color + '20;color:' + s.verdict_color + '">' + s.verdict + '</div>' +
            '</div>';
        }
        
        var moatHtml = '<div class="moat-row"><div class="metric-row"><span class="label">Moat</span><span class="value ' + (r1.has_moat ? 'good' : 'warn') + '">' + (r1.has_moat ? 'üè∞ Strong' : '‚ö†Ô∏è Uncertain') + '</span></div></div>';
        
        rule1Html = '<div class="card">' +
            '<div class="card-title">üìè Rule #1 Investing</div>' +
            '<div class="big5-header"><span class="big5-label">Big 5 Numbers</span><span class="big5-score ' + b5cls + '">' + r1.big5_passing + '/' + r1.big5_total + ' passing</span></div>' +
            big5Rows + moatHtml + stickerHtml +
        '</div>';
    }
    
    // Algorithm detail
    var fvCompHtml = '';
    for (var j = 0; j < fvComps.length; j++) {
        fvCompHtml += '<div class="algo-component"><span>' + fvComps[j].label + '</span><span class="val">$' + fvComps[j].value.toFixed(2) + '</span></div>';
    }
    
    var stickerFormulaHtml = '';
    if (r1.sticker) {
        var st = r1.sticker;
        stickerFormulaHtml = '<div class="algo-section">' +
            '<h4>üìè Rule #1 Sticker Price Formula</h4>' +
            '<div class="formula">Sticker = EPS √ó (1+g)¬π‚Å∞ √ó min(2√óg%, 50) √∑ 1.15¬π‚Å∞<br>MOS Price = Sticker √∑ 2</div>' +
            '<div class="algo-component"><span>Current EPS</span><span class="val">$' + st.eps.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>Growth Rate (' + st.growth_source + ')</span><span class="val">' + st.growth_rate + '%</span></div>' +
            '<div class="algo-component"><span>Future EPS (10yr)</span><span class="val">$' + st.future_eps.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>Future PE (2 √ó growth%)</span><span class="val">' + st.future_pe.toFixed(1) + 'x</span></div>' +
            '<div class="algo-component"><span>Future Market Price</span><span class="val">$' + st.future_price.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>√∑ 1.15¬π‚Å∞ (15% MARR) = Sticker</span><span class="val">$' + st.sticker_price.toFixed(2) + '</span></div>' +
            '<div class="algo-component"><span>√∑ 2 (50% MOS) = Buy Price</span><span class="val" style="color:#00d374">$' + st.mos_price.toFixed(2) + '</span></div>' +
        '</div>';
    }
    
    var algoHtml = '<div class="card" style="grid-column:1/-1">' +
        '<div class="algo-toggle" onclick="toggleAlgo()">üî¨ View Algorithm Details ‚Äî How Everything is Calculated ‚ñº</div>' +
        '<div id="algoDetail" class="algo-detail" style="display:none">' +
            '<div class="algo-section">' +
                '<h4>üìä Investment Score (100 pts max)</h4>' +
                '<p>Points awarded across 7 financial health criteria:</p>' +
                '<div class="algo-row"><span>Return on Assets (ROA) &gt; 10%</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Return on Equity (ROE) &gt; 10%</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Cash ‚â• Total Debt</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row"><span>Undervalued &gt;30% vs blended fair value</span><span class="pts">20 pts</span></div>' +
                '<div class="algo-row"><span>Profit Margin &gt; 15%</span><span class="pts">10 pts</span></div>' +
                '<div class="algo-row"><span>Price/Sales &lt; 2x</span><span class="pts">10 pts</span></div>' +
                '<div class="algo-row"><span>Positive Free Cash Flow</span><span class="pts">15 pts</span></div>' +
                '<div class="algo-row" style="border-top:2px solid #222;padding-top:6px;margin-top:4px;font-weight:600;color:#ccc"><span>Maximum Score</span><span class="pts">100 pts</span></div>' +
                '<p style="margin-top:6px;font-size:11px;color:#555">Partial credit: ROA/ROE 5-10% ‚Üí 7pts. Undervalue 10-30% ‚Üí 10pts. Margin 5-15% ‚Üí 5pts.</p>' +
            '</div>' +
            '<div class="algo-section">' +
                '<h4>üìê Fair Value Calculation</h4>' +
                '<p>Blended average of ' + fvComps.length + ' valuation model(s):</p>' +
                fvCompHtml +
                '<div class="algo-component" style="border-top:2px solid #222;padding-top:6px;margin-top:6px;font-weight:600"><span style="color:#ccc">= Blended Fair Value</span><span class="val" style="color:#00d374">$' + (data.fair_value || 0).toFixed(2) + '</span></div>' +
                '<p style="margin-top:6px;font-size:11px;color:#555">Includes: analyst targets, forward PE, PEG growth-adjusted PE, and PE-based adjustments when available.</p>' +
            '</div>' +
            stickerFormulaHtml +
        '</div></div>';
    
    document.getElementById('detail').innerHTML = r.topSection +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üí∞ Valuation</div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + fmtRatio(f.pe_ratio) + '</span></div>' +
                '<div class="metric-row"><span class="label">Forward PE</span><span class="value">' + fmtRatio(f.forward_pe) + '</span></div>' +
                '<div class="metric-row"><span class="label">PEG Ratio</span><span class="value">' + fmtRatio(f.peg_ratio) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/S Ratio</span><span class="value ' + (f.ps_ratio != null && f.ps_ratio < 2 ? 'good' : '') + '">' + fmtRatio(f.ps_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">P/B Ratio</span><span class="value">' + fmtRatio(f.pb_ratio, 2) + '</span></div>' +
                '<div class="metric-row"><span class="label">Market Cap</span><span class="value">' + formatNum(q.market_cap) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìä Profitability & Growth</div>' +
                '<div class="metric-row"><span class="label">ROA</span><span class="value ' + pctClass(f.roa) + '">' + fmtPct(f.roa) + '</span></div>' +
                '<div class="metric-row"><span class="label">ROE</span><span class="value ' + pctClass(f.roe) + '">' + fmtPct(f.roe) + '</span></div>' +
                '<div class="metric-row"><span class="label">Profit Margin</span><span class="value ' + pctClass(f.profit_margin, 10, 5) + '">' + fmtPct(f.profit_margin) + '</span></div>' +
                '<div class="metric-row"><span class="label">Gross Margin</span><span class="value">' + fmtPct(f.gross_margin) + '</span></div>' +
                (g.revenue != null ? '<div class="metric-row"><span class="label">Revenue Growth' + trend(g.revenue_trend) + '</span><span class="value ' + (g.revenue > 10 ? 'good' : g.revenue > 0 ? 'warn' : 'bad') + '">' + g.revenue.toFixed(1) + '%</span></div>' : '') +
                (g.earnings != null ? '<div class="metric-row"><span class="label">Earnings Growth' + trend(g.earnings_trend) + '</span><span class="value ' + (g.earnings > 10 ? 'good' : g.earnings > 0 ? 'warn' : 'bad') + '">' + g.earnings.toFixed(1) + '%</span></div>' : '') +
            '</div>' +
            '<div class="card"><div class="card-title">üè¶ Balance Sheet</div>' +
                '<div class="metric-row"><span class="label">Cash</span><span class="value ' + (f.cash ? 'good' : '') + '">' + formatNum(f.cash) + '</span></div>' +
                '<div class="metric-row"><span class="label">Debt</span><span class="value ' + (f.debt > f.cash ? 'bad' : '') + '">' + formatNum(f.debt) + '</span></div>' +
                '<div class="metric-row"><span class="label">Net Cash</span><span class="value ' + (f.cash >= f.debt ? 'good' : 'bad') + '">' + (f.cash != null && f.debt != null ? formatNum(f.cash - f.debt) : 'N/A') + '</span></div>' +
                '<div class="metric-row"><span class="label">Free Cash Flow</span><span class="value ' + (f.fcf > 0 ? 'good' : f.fcf != null ? 'bad' : '') + '">' + formatNum(f.fcf) + '</span></div>' +
            '</div>' +
            rule1Html +
            r.scoreSection +
            algoHtml +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    loadPerformance(data.symbol);
}

function toggleAlgo() {
    var el = document.getElementById('algoDetail');
    var toggle = document.querySelector('.algo-toggle');
    if (el.style.display === 'none') {
        el.style.display = 'block';
        toggle.textContent = 'üî¨ Hide Algorithm Details ‚ñ≤';
    } else {
        el.style.display = 'none';
        toggle.textContent = 'üî¨ View Algorithm Details ‚Äî How Everything is Calculated ‚ñº';
    }
}

function back() {
    document.getElementById('detail').className = 'detail-view';
    document.getElementById('mainTabs').style.display = 'flex';
    // Re-show the active tab content
    var activeTab = document.querySelector('.tab.active');
    if (activeTab) {
        var tabName = activeTab.textContent.includes('Market') ? 'market' : activeTab.textContent.includes('Saved') ? 'watchlist' : 'foryou';
        document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    } else {
        document.getElementById('tabMarket').classList.add('active');
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
    setTimeout(function() { document.getElementById('error').style.display = 'none'; }, 5000);
}

function formatNum(n) {
    if (n === null || n === undefined) return 'N/A';
    if (n === 0) return '$0';
    if (Math.abs(n) >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
    if (Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}
</script>
</body>
</html>