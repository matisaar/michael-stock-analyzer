<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michael's Stock Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #00d374; font-size: 28px; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; }
        .api-box { background: #111; border: 1px solid #333; border-radius: 12px; padding: 16px; margin-bottom: 24px; }
        .api-box h3 { color: #00d374; margin-bottom: 12px; font-size: 14px; }
        .api-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
        .api-row label { color: #888; font-size: 13px; min-width: 120px; }
        .api-box input { padding: 8px 12px; flex: 1; min-width: 200px; background: #0a0a0a; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 13px; }
        .api-box button { padding: 8px 16px; background: #00d374; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; }
        .api-box a { color: #00d374; }
        .api-status { font-size: 12px; color: #666; margin-top: 8px; }
        .api-status.connected { color: #00d374; }
        .search-section { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 24px; }
        .search-input { padding: 14px 20px; width: 350px; background: #111; border: 1px solid #333; border-radius: 10px; color: #fff; font-size: 16px; }
        .search-input:focus { outline: none; border-color: #00d374; }
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #00d374; color: #000; }
        .btn-secondary { background: #222; color: #fff; border: 1px solid #333; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stock-card { background: #111; border: 1px solid #222; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .stock-card:hover { border-color: #00d374; transform: translateY(-2px); }
        .stock-card h3 { font-size: 18px; margin-bottom: 4px; }
        .stock-card .ticker { color: #666; font-size: 14px; }
        .stock-card .price { font-size: 24px; font-weight: 700; margin-top: 12px; }
        .stock-card .change { font-size: 14px; padding: 4px 10px; border-radius: 6px; display: inline-block; margin-top: 8px; }
        .stock-card .change.up { background: rgba(0,211,116,0.15); color: #00d374; }
        .stock-card .change.down { background: rgba(255,82,82,0.15); color: #ff5252; }
        .stock-card .score-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-top: 8px; margin-left: 8px; }
        .stock-card .score-badge.high { background: rgba(0,211,116,0.15); color: #00d374; }
        .stock-card .score-badge.medium { background: rgba(255,184,0,0.15); color: #ffb800; }
        .stock-card .score-badge.low { background: rgba(255,82,82,0.15); color: #ff5252; }
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .back-btn { background: #222; color: #fff; margin-bottom: 20px; border: 1px solid #333; padding: 12px 24px; border-radius: 10px; cursor: pointer; }
        .alert { background: linear-gradient(135deg, rgba(0,211,116,0.1), rgba(0,211,116,0.05)); border: 1px solid #00d374; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; }
        .alert h3 { color: #00d374; }
        .alert p { color: #888; font-size: 14px; }
        .header-card { background: #111; border-radius: 16px; padding: 24px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { width: 64px; height: 64px; background: linear-gradient(135deg, #00d374, #00a060); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; }
        .header-info h2 { font-size: 22px; }
        .header-info span { color: #666; font-size: 14px; }
        .header-right .price { font-size: 32px; font-weight: 700; }
        .header-right .change { font-size: 16px; padding: 6px 14px; border-radius: 8px; display: inline-block; margin-top: 8px; }
        .fair-value-card { background: linear-gradient(135deg, #0d3320, #0a1a10); border: 1px solid #00d374; border-radius: 16px; padding: 24px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .fair-value-card h3 { color: #00d374; }
        .fair-value-card .upside { font-size: 36px; font-weight: 700; color: #00d374; }
        .fair-value-card .details { display: flex; gap: 30px; flex-wrap: wrap; }
        .fair-value-card .detail-item label { display: block; color: #666; font-size: 11px; text-transform: uppercase; }
        .fair-value-card .detail-item span { font-size: 20px; font-weight: 600; }
        .recommendation-card { background: #111; border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
        .recommendation-card .signal { font-size: 24px; font-weight: 700; }
        .recommendation-card .reason { color: #888; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .card { background: #111; border-radius: 14px; padding: 20px; }
        .card-title { color: #666; font-size: 13px; text-transform: uppercase; margin-bottom: 16px; }
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #1a1a1a; }
        .metric-row:last-child { border-bottom: none; }
        .metric-row .label { color: #888; }
        .metric-row .value { font-weight: 600; }
        .metric-row .value.good { color: #00d374; }
        .metric-row .value.bad { color: #ff5252; }
        .metric-row .value.warn { color: #ffb800; }
        .score-card { text-align: center; }
        .score-ring { width: 130px; height: 130px; margin: 0 auto 16px; position: relative; }
        .score-ring svg { transform: rotate(-90deg); }
        .score-ring circle { fill: none; stroke-width: 10; }
        .score-ring .bg { stroke: #222; }
        .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .score-text .num { font-size: 32px; font-weight: 700; }
        .score-text .label { font-size: 12px; color: #666; }
        .checklist { list-style: none; text-align: left; }
        .checklist li { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 13px; }
        .checklist .icon { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .checklist .icon.pass { background: #00d374; color: #000; }
        .checklist .icon.fail { background: #ff5252; color: #fff; }
        .checklist .icon.warn { background: #ffb800; color: #000; }
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 40px; height: 40px; border: 3px solid #222; border-top-color: #00d374; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { background: rgba(255,82,82,0.1); border: 1px solid #ff5252; color: #ff5252; padding: 16px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        footer { text-align: center; color: #444; padding: 30px; font-size: 13px; }
        .backend-badge { display: inline-block; background: #1a1a1a; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #00d374; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà Michael's Stock Analyzer <span class="backend-badge">Python Backend</span></h1>
        <p class="subtitle">Investment analysis with Michael's criteria (ROA/ROE >10%, Cash vs Debt, Fair Value)</p>
        
        <div class="api-box">
            <h3>üîë API Configuration</h3>
            <div class="api-row">
                <label>Tradier (quotes):</label>
                <input type="text" id="tradierKey" placeholder="Tradier sandbox key (free at developer.tradier.com)">
            </div>
            <div class="api-row">
                <label>FMP (fundamentals):</label>
                <input type="text" id="fmpKey" placeholder="FMP API key (free at financialmodelingprep.com)">
            </div>
            <div class="api-row">
                <button onclick="saveKeys()">Save Keys</button>
                <span class="api-status" id="apiStatus">Checking backend...</span>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 12px;">
                Get free keys: <a href="https://developer.tradier.com/" target="_blank">Tradier</a> (sandbox for quotes) | 
                <a href="https://site.financialmodelingprep.com/developer/docs" target="_blank">FMP</a> (250 calls/day, fundamentals)
            </p>
        </div>
        
        <div class="search-section">
            <input type="text" class="search-input" id="searchInput" placeholder="Enter stock ticker (AAPL, TSLA, CRCT...)" list="tickerList">
            <datalist id="tickerList"></datalist>
            <button class="btn btn-primary" onclick="analyze()">üîç Analyze</button>
            <button class="btn btn-secondary" onclick="scanOpportunities()">üîé Scan Opportunities</button>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;"><div class="spinner"></div><p>Analyzing with Python backend...</p></div>
        
        <div id="grid">
            <h2 style="color:#888;font-size:15px;margin-bottom:16px;">üìä Click a stock to analyze (data from Python backend)</h2>
            <div class="stock-grid" id="stockGrid"></div>
        </div>
        
        <div id="detail" class="detail-view"></div>
        
        <footer>
            Built for Michael ‚Ä¢ Python Backend + Tradier/FMP APIs ‚Ä¢ <span id="update"></span>
        </footer>
    </div>

<script>
// API base URL (Python Flask backend)
const API_BASE = window.location.origin;

// Check backend health on load
async function checkBackend() {
    const statusEl = document.getElementById('apiStatus');
    try {
        const resp = await fetch(API_BASE + '/api/health');
        const data = await resp.json();
        
        if (data.status === 'ok') {
            let status = '‚úÖ Backend connected';
            if (data.tradier_configured) status += ' | Tradier ‚úì';
            if (data.fmp_configured) status += ' | FMP ‚úì';
            if (!data.tradier_configured && !data.fmp_configured) {
                status += ' | ‚ö†Ô∏è No API keys configured';
            }
            statusEl.textContent = status;
            statusEl.className = 'api-status connected';
        }
    } catch (e) {
        statusEl.textContent = '‚ùå Backend not running. Start with: python app.py';
        statusEl.className = 'api-status';
    }
}

// Save API keys to backend
async function saveKeys() {
    const tradierKey = document.getElementById('tradierKey').value.trim();
    const fmpKey = document.getElementById('fmpKey').value.trim();
    
    try {
        const resp = await fetch(API_BASE + '/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tradier_key: tradierKey, fmp_key: fmpKey })
        });
        const data = await resp.json();
        
        if (data.status === 'ok') {
            if (tradierKey) localStorage.setItem('tradier_key', tradierKey);
            if (fmpKey) localStorage.setItem('fmp_key', fmpKey);
            
            alert('API keys saved! Backend is ready.');
            checkBackend();
            loadDefaultStocks();
        }
    } catch (e) {
        alert('Error saving keys. Is the backend running?');
    }
}

// Load saved keys
function loadSavedKeys() {
    const tradierKey = localStorage.getItem('tradier_key');
    const fmpKey = localStorage.getItem('fmp_key');
    
    if (tradierKey) document.getElementById('tradierKey').value = tradierKey;
    if (fmpKey) document.getElementById('fmpKey').value = fmpKey;
    
    if (tradierKey || fmpKey) {
        fetch(API_BASE + '/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tradier_key: tradierKey || '', fmp_key: fmpKey || '' })
        }).catch(function() {});
    }
}

// Load default stocks for the grid
async function loadDefaultStocks() {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px"><div class="spinner"></div></div>';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            displayStockGrid(data.opportunities);
        } else {
            grid.innerHTML = '<p style="color:#666;grid-column:1/-1;text-align:center;">Configure API keys to load stock data</p>';
        }
    } catch (e) {
        grid.innerHTML = '<p style="color:#ff5252;grid-column:1/-1;text-align:center;">Backend not running. Start with: python app.py</p>';
    }
}

function displayStockGrid(stocks) {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = stocks.map(function(s) {
        const scoreClass = s.score >= 60 ? 'high' : s.score >= 40 ? 'medium' : 'low';
        const changeClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        const changeSymbol = (s.upside || 0) >= 0 ? '‚ñ≤' : '‚ñº';
        
        return '<div class="stock-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<h3>' + (s.name || s.symbol) + '</h3>' +
            '<span class="ticker">' + s.symbol + '</span>' +
            '<div class="price">$' + (s.price || 0).toFixed(2) + '</div>' +
            '<span class="change ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(s.upside || 0).toFixed(0) + '% upside</span>' +
            '<span class="score-badge ' + scoreClass + '">Score: ' + (s.score || 0) + '</span>' +
            '</div>';
    }).join('');
}

// Scan for opportunities
async function scanOpportunities() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'block';
    document.getElementById('detail').className = 'detail-view';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.opportunities) {
            displayStockGrid(data.opportunities);
        }
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Backend not running. Start with: python app.py');
    }
}

// Analyze single stock
async function analyze(sym) {
    sym = sym || document.getElementById('searchInput').value.trim().toUpperCase();
    if (!sym) {
        showError('Enter a stock ticker');
        return;
    }
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'none';
    document.getElementById('detail').className = 'detail-view';
    
    try {
        const resp = await fetch(API_BASE + '/api/analyze/' + sym);
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.error) {
            showError(data.error);
            document.getElementById('grid').style.display = 'block';
            return;
        }
        
        displayAnalysis(data);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Backend not running. Start with: python app.py');
        document.getElementById('grid').style.display = 'block';
    }
}

function displayAnalysis(data) {
    const q = data.quote || {};
    const f = data.fundamentals || {};
    const rec = data.recommendation || {};
    const checks = data.checklist || [];
    
    const price = q.price || 0;
    const fairValue = data.fair_value || price;
    const upside = data.upside_percent || 0;
    const score = data.investment_score || 0;
    
    const changeClass = (q.change_percent || 0) >= 0 ? 'up' : 'down';
    const changeSymbol = (q.change_percent || 0) >= 0 ? '‚ñ≤' : '‚ñº';
    
    const col = score >= 60 ? '#00d374' : (score >= 40 ? '#ffb800' : '#ff5252');
    const circ = 2 * Math.PI * 55;
    const off = circ - (score / 100) * circ;
    
    let alertHtml = '';
    if (upside > 20) {
        alertHtml = '<div class="alert"><span style="font-size:28px">üíé</span><div><h3>Opportunity Detected!</h3><p>' + data.symbol + ' is ' + upside.toFixed(0) + '% below estimated fair value (calculated by Python backend)</p></div></div>';
    }
    
    let checklistHtml = '';
    for (let i = 0; i < checks.length; i++) {
        const c = checks[i];
        const icon = c.pass === true ? '‚úì' : (c.pass === 'warn' ? '!' : '‚úó');
        const iconClass = c.pass === true ? 'pass' : (c.pass === 'warn' ? 'warn' : 'fail');
        checklistHtml += '<li><span class="icon ' + iconClass + '">' + icon + '</span>' + c.text + '</li>';
    }
    
    document.getElementById('detail').innerHTML = 
        '<button class="back-btn" onclick="back()">‚Üê Back</button>' +
        alertHtml +
        '<div class="recommendation-card" style="border-left: 4px solid ' + (rec.color || '#666') + '">' +
            '<div><div class="signal" style="color: ' + (rec.color || '#fff') + '">' + (rec.signal || 'ANALYZING') + '</div>' +
            '<div class="reason">' + (rec.reason || 'Based on Michael\'s investment criteria') + '</div></div>' +
        '</div>' +
        '<div class="header-card">' +
            '<div class="header-left">' +
                '<div class="logo">' + data.symbol.slice(0,4) + '</div>' +
                '<div class="header-info"><h2>' + (q.name || data.symbol) + '</h2>' +
                '<span>' + data.symbol + ' ‚Ä¢ ' + (q.industry || q.sector || 'N/A') + '</span></div>' +
            '</div>' +
            '<div class="header-right">' +
                '<div class="price">$' + price.toFixed(2) + '</div>' +
                '<span class="change ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(q.change_percent || 0).toFixed(2) + '%</span>' +
            '</div>' +
        '</div>' +
        '<div class="fair-value-card">' +
            '<div><h3>üìà Calculated Upside</h3><div class="upside">' + (upside > 0 ? '+' : '') + upside.toFixed(0) + '%</div></div>' +
            '<div class="details">' +
                '<div class="detail-item"><label>Current</label><span>$' + price.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>Fair Value</label><span style="color:#00d374">$' + fairValue.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>52W Range</label><span>$' + (q.week_52_low || 0).toFixed(0) + '-$' + (q.week_52_high || 0).toFixed(0) + '</span></div>' +
            '</div>' +
        '</div>' +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üí∞ Valuation</div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + (f.pe_ratio || 0).toFixed(1) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">P/S Ratio</span><span class="value ' + ((f.ps_ratio || 0) < 2 ? 'good' : '') + '">' + (f.ps_ratio || 0).toFixed(2) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">P/B Ratio</span><span class="value">' + (f.pb_ratio || 0).toFixed(2) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">Market Cap</span><span class="value">' + formatNum(q.market_cap) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìä Profitability</div>' +
                '<div class="metric-row"><span class="label">ROA</span><span class="value ' + ((f.roa || 0) > 10 ? 'good' : (f.roa || 0) > 5 ? 'warn' : '') + '">' + (f.roa || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">ROE</span><span class="value ' + ((f.roe || 0) > 10 ? 'good' : (f.roe || 0) > 5 ? 'warn' : '') + '">' + (f.roe || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">Profit Margin</span><span class="value ' + ((f.profit_margin || 0) > 10 ? 'good' : '') + '">' + (f.profit_margin || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">Gross Margin</span><span class="value">' + (f.gross_margin || 0).toFixed(1) + '%</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üè¶ Balance Sheet</div>' +
                '<div class="metric-row"><span class="label">Cash</span><span class="value good">' + formatNum(f.cash) + '</span></div>' +
                '<div class="metric-row"><span class="label">Debt</span><span class="value ' + ((f.debt || 0) > (f.cash || 0) ? 'bad' : '') + '">' + formatNum(f.debt) + '</span></div>' +
                '<div class="metric-row"><span class="label">Net Cash</span><span class="value ' + ((f.cash || 0) >= (f.debt || 0) ? 'good' : 'bad') + '">' + formatNum((f.cash || 0) - (f.debt || 0)) + '</span></div>' +
                '<div class="metric-row"><span class="label">Free Cash Flow</span><span class="value ' + ((f.fcf || 0) > 0 ? 'good' : 'bad') + '">' + formatNum(f.fcf) + '</span></div>' +
            '</div>' +
            '<div class="card score-card"><div class="card-title">‚≠ê Michael\'s Score</div>' +
                '<div class="score-ring">' +
                    '<svg width="130" height="130"><circle class="bg" cx="65" cy="65" r="55"></circle><circle cx="65" cy="65" r="55" stroke="' + col + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg>' +
                    '<div class="score-text"><div class="num" style="color:' + col + '">' + score + '</div><div class="label">/100</div></div>' +
                '</div>' +
                '<ul class="checklist">' + checklistHtml + '</ul>' +
            '</div>' +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
    document.getElementById('update').textContent = new Date().toLocaleTimeString();
}

function back() {
    document.getElementById('detail').className = 'detail-view';
    document.getElementById('grid').style.display = 'block';
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
}

function formatNum(n) {
    if (!n && n !== 0) return 'N/A';
    if (Math.abs(n) >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
    if (Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}

// Load tickers for autocomplete
async function loadTickers() {
    try {
        const resp = await fetch(API_BASE + '/api/tickers');
        const data = await resp.json();
        
        if (data.tickers) {
            const datalist = document.getElementById('tickerList');
            const popular = data.tickers.slice(0, 100);
            for (let i = 0; i < popular.length; i++) {
                const opt = document.createElement('option');
                opt.value = popular[i];
                datalist.appendChild(opt);
            }
        }
    } catch (e) {
        console.log('Could not load tickers');
    }
}

// Enter key support
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') analyze();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadSavedKeys();
    checkBackend();
    loadTickers();
    loadDefaultStocks();
    document.getElementById('update').textContent = new Date().toLocaleTimeString();
});
</script>
</body>
</html>
