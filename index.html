<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michael's Stock Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0a0a 0%, #111 100%); color: #fff; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 36px; font-weight: 700; margin-bottom: 8px; }
        .header h1 span { background: linear-gradient(135deg, #00d374, #00a060); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { color: #666; font-size: 16px; }
        
        /* Search */
        .search-box { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 40px; }
        .search-input { 
            padding: 16px 24px; width: 400px; max-width: 100%; 
            background: #151515; border: 2px solid #222; border-radius: 14px; 
            color: #fff; font-size: 18px; transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: #00d374; background: #1a1a1a; }
        .search-input::placeholder { color: #555; }
        .btn { 
            padding: 16px 32px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #00d374, #00a060); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,211,116,0.3); }
        .btn-secondary { background: #1a1a1a; color: #fff; border: 2px solid #333; }
        .btn-secondary:hover { border-color: #00d374; }
        
        /* Stock Grid */
        .section-title { color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stock-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border: 1px solid #222; border-radius: 20px; padding: 24px; 
            cursor: pointer; transition: all 0.3s;
        }
        .stock-card:hover { border-color: #00d374; transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
        .stock-card h3 { font-size: 18px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stock-card .ticker { color: #666; font-size: 14px; font-weight: 500; }
        .stock-card .price { font-size: 28px; font-weight: 700; margin-top: 16px; }
        .stock-card .badges { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .badge { font-size: 13px; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
        .badge.up { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.down { background: rgba(255,82,82,0.15); color: #ff5252; }
        .badge.score-high { background: rgba(0,211,116,0.15); color: #00d374; }
        .badge.score-medium { background: rgba(255,184,0,0.15); color: #ffb800; }
        .badge.score-low { background: rgba(255,82,82,0.15); color: #ff5252; }
        
        /* Detail View */
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .back-btn { 
            background: #1a1a1a; color: #888; border: 1px solid #333; 
            padding: 12px 20px; border-radius: 10px; cursor: pointer; 
            margin-bottom: 24px; font-size: 14px; transition: all 0.2s;
        }
        .back-btn:hover { color: #fff; border-color: #444; }
        
        /* Alert Banner */
        .alert { 
            background: linear-gradient(135deg, rgba(0,211,116,0.1), rgba(0,211,116,0.03)); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 16px; 
            padding: 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;
        }
        .alert-icon { font-size: 32px; }
        .alert h3 { color: #00d374; font-size: 18px; margin-bottom: 4px; }
        .alert p { color: #888; font-size: 14px; }
        
        /* Header Card */
        .header-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 20px; padding: 28px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .stock-logo { 
            width: 70px; height: 70px; 
            background: linear-gradient(135deg, #00d374, #00a060); 
            border-radius: 16px; display: flex; align-items: center; justify-content: center; 
            font-size: 18px; font-weight: 700; color: #000;
        }
        .header-info h2 { font-size: 24px; margin-bottom: 4px; }
        .header-info .meta { color: #666; font-size: 14px; }
        .header-right .current-price { font-size: 36px; font-weight: 700; }
        .header-right .price-change { font-size: 16px; padding: 8px 16px; border-radius: 10px; display: inline-block; margin-top: 8px; }
        
        /* Recommendation Card */
        .recommendation-card { 
            background: linear-gradient(145deg, #151515, #111); 
            border-radius: 16px; padding: 24px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 20px;
        }
        .recommendation-card .signal { font-size: 28px; font-weight: 700; }
        .recommendation-card .reason { color: #888; font-size: 15px; }
        
        /* Fair Value Card */
        .fair-value-card { 
            background: linear-gradient(135deg, #0d3320, #0a1a10); 
            border: 1px solid rgba(0,211,116,0.3); border-radius: 20px; 
            padding: 28px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 24px;
        }
        .fair-value-card h3 { color: #00d374; font-size: 16px; margin-bottom: 8px; }
        .fair-value-card .upside { font-size: 42px; font-weight: 700; color: #00d374; }
        .fair-value-card .details { display: flex; gap: 40px; flex-wrap: wrap; }
        .detail-item label { display: block; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .detail-item span { font-size: 22px; font-weight: 600; }
        
        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: linear-gradient(145deg, #151515, #111); border-radius: 16px; padding: 24px; }
        .card-title { color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .metric-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1a1a1a; }
        .metric-row:last-child { border-bottom: none; }
        .metric-row .label { color: #888; }
        .metric-row .value { font-weight: 600; font-size: 15px; }
        .metric-row .value.good { color: #00d374; }
        .metric-row .value.bad { color: #ff5252; }
        .metric-row .value.warn { color: #ffb800; }
        
        /* Score Card */
        .score-card { text-align: center; }
        .score-ring { width: 140px; height: 140px; margin: 0 auto 20px; position: relative; }
        .score-ring svg { transform: rotate(-90deg); }
        .score-ring circle { fill: none; stroke-width: 10; }
        .score-ring .bg { stroke: #222; }
        .score-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .score-text .num { font-size: 36px; font-weight: 700; }
        .score-text .label { font-size: 12px; color: #666; }
        .checklist { list-style: none; text-align: left; margin-top: 16px; }
        .checklist li { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 13px; }
        .checklist .icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
        .checklist .icon.pass { background: #00d374; color: #000; }
        .checklist .icon.fail { background: #ff5252; color: #fff; }
        .checklist .icon.warn { background: #ffb800; color: #000; }
        
        /* Loading & Error */
        .loading { text-align: center; padding: 80px 20px; }
        .spinner { width: 50px; height: 50px; border: 3px solid #222; border-top-color: #00d374; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: #666; font-size: 16px; }
        .error { background: rgba(255,82,82,0.1); border: 1px solid rgba(255,82,82,0.3); color: #ff5252; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        
        /* Footer */
        footer { text-align: center; color: #333; padding: 40px 20px; font-size: 13px; }
        footer a { color: #00d374; text-decoration: none; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #555; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà <span>Michael's Stock Analyzer</span></h1>
            <p>Smart investment analysis ‚Ä¢ ROA/ROE &gt;10% ‚Ä¢ Cash vs Debt ‚Ä¢ Fair Value</p>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search any stock (AAPL, TSLA, NVDA...)" list="tickerList">
            <datalist id="tickerList"></datalist>
            <button class="btn btn-primary" onclick="analyze()">üîç Analyze</button>
            <button class="btn btn-secondary" onclick="scanOpportunities()">üìä Refresh</button>
        </div>
        
        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p>Analyzing stocks...</p>
        </div>
        
        <div id="grid">
            <div class="section-title">üìä Top Stocks to Analyze</div>
            <div class="stock-grid" id="stockGrid"></div>
        </div>
        
        <div id="detail" class="detail-view"></div>
        
        <footer>
            Built with ‚ù§Ô∏è for Michael
        </footer>
    </div>

<script>
const API_BASE = window.location.origin;

// Load stocks on page load
async function loadDefaultStocks() {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px"><div class="spinner" style="width:50px;height:50px;border:3px solid #222;border-top-color:#00d374;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px"></div><p style="color:#666">Loading stocks...</p></div>';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        if (data.opportunities && data.opportunities.length > 0) {
            displayStockGrid(data.opportunities);
        } else {
            grid.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>No stocks loaded yet. Try refreshing!</p></div>';
        }
    } catch (e) {
        // Retry on cold start
        setTimeout(loadDefaultStocks, 2500);
    }
}

function displayStockGrid(stocks) {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = stocks.map(function(s) {
        const scoreClass = s.score >= 60 ? 'score-high' : s.score >= 40 ? 'score-medium' : 'score-low';
        const upsideClass = (s.upside || 0) >= 0 ? 'up' : 'down';
        const arrow = (s.upside || 0) >= 0 ? '‚Üë' : '‚Üì';
        
        return '<div class="stock-card" onclick="analyze(\'' + s.symbol + '\')">' +
            '<h3>' + (s.name || s.symbol) + '</h3>' +
            '<span class="ticker">' + s.symbol + '</span>' +
            '<div class="price">$' + (s.price || 0).toFixed(2) + '</div>' +
            '<div class="badges">' +
                '<span class="badge ' + upsideClass + '">' + arrow + ' ' + Math.abs(s.upside || 0).toFixed(0) + '% upside</span>' +
                '<span class="badge ' + scoreClass + '">Score: ' + (s.score || 0) + '</span>' +
            '</div>' +
        '</div>';
    }).join('');
}

async function scanOpportunities() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'block';
    document.getElementById('detail').className = 'detail-view';
    
    try {
        const resp = await fetch(API_BASE + '/api/scan');
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.opportunities) {
            displayStockGrid(data.opportunities);
        }
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Connection error. Please try again.');
    }
}

async function analyze(sym) {
    sym = sym || document.getElementById('searchInput').value.trim().toUpperCase();
    if (!sym) {
        showError('Please enter a stock ticker');
        return;
    }
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('grid').style.display = 'none';
    document.getElementById('detail').className = 'detail-view';
    
    try {
        const resp = await fetch(API_BASE + '/api/analyze/' + sym);
        const data = await resp.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.error) {
            showError(data.error);
            document.getElementById('grid').style.display = 'block';
            return;
        }
        
        displayAnalysis(data);
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        showError('Error analyzing stock. Please try again.');
        document.getElementById('grid').style.display = 'block';
    }
}

function displayAnalysis(data) {
    const q = data.quote || {};
    const f = data.fundamentals || {};
    const rec = data.recommendation || {};
    const checks = data.checklist || [];
    
    const price = q.price || 0;
    const fairValue = data.fair_value || price;
    const upside = data.upside_percent || 0;
    const score = data.investment_score || 0;
    
    const changeClass = (q.change_percent || 0) >= 0 ? 'up' : 'down';
    const changeSymbol = (q.change_percent || 0) >= 0 ? '‚Üë' : '‚Üì';
    
    const col = score >= 60 ? '#00d374' : (score >= 40 ? '#ffb800' : '#ff5252');
    const circ = 2 * Math.PI * 55;
    const off = circ - (score / 100) * circ;
    
    let alertHtml = '';
    if (upside > 20) {
        alertHtml = '<div class="alert"><span class="alert-icon">üíé</span><div><h3>Opportunity Detected!</h3><p>' + data.symbol + ' appears to be ' + upside.toFixed(0) + '% undervalued based on fair value analysis</p></div></div>';
    }
    
    let checklistHtml = '';
    for (let i = 0; i < checks.length; i++) {
        const c = checks[i];
        const icon = c.pass === true ? '‚úì' : (c.pass === 'warn' ? '!' : '‚úó');
        const iconClass = c.pass === true ? 'pass' : (c.pass === 'warn' ? 'warn' : 'fail');
        checklistHtml += '<li><span class="icon ' + iconClass + '">' + icon + '</span>' + c.text + '</li>';
    }
    
    document.getElementById('detail').innerHTML = 
        '<button class="back-btn" onclick="back()">‚Üê Back to all stocks</button>' +
        alertHtml +
        '<div class="recommendation-card" style="border-left: 4px solid ' + (rec.color || '#666') + '">' +
            '<div><div class="signal" style="color: ' + (rec.color || '#fff') + '">' + (rec.signal || 'ANALYZING') + '</div>' +
            '<div class="reason">' + (rec.reason || 'Based on investment criteria') + '</div></div>' +
        '</div>' +
        '<div class="header-card">' +
            '<div class="header-left">' +
                '<div class="stock-logo">' + data.symbol.slice(0,4) + '</div>' +
                '<div class="header-info"><h2>' + (q.name || data.symbol) + '</h2>' +
                '<span class="meta">' + data.symbol + ' ‚Ä¢ ' + (q.industry || q.sector || 'Stock') + '</span></div>' +
            '</div>' +
            '<div class="header-right">' +
                '<div class="current-price">$' + price.toFixed(2) + '</div>' +
                '<span class="price-change badge ' + changeClass + '">' + changeSymbol + ' ' + Math.abs(q.change_percent || 0).toFixed(2) + '%</span>' +
            '</div>' +
        '</div>' +
        '<div class="fair-value-card">' +
            '<div><h3>üìà Calculated Upside</h3><div class="upside">' + (upside > 0 ? '+' : '') + upside.toFixed(0) + '%</div></div>' +
            '<div class="details">' +
                '<div class="detail-item"><label>Current Price</label><span>$' + price.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>Fair Value</label><span style="color:#00d374">$' + fairValue.toFixed(2) + '</span></div>' +
                '<div class="detail-item"><label>52W Range</label><span>$' + (q.week_52_low || 0).toFixed(0) + ' - $' + (q.week_52_high || 0).toFixed(0) + '</span></div>' +
            '</div>' +
        '</div>' +
        '<div class="metrics-grid">' +
            '<div class="card"><div class="card-title">üí∞ Valuation</div>' +
                '<div class="metric-row"><span class="label">P/E Ratio</span><span class="value">' + (f.pe_ratio || 0).toFixed(1) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">P/S Ratio</span><span class="value ' + ((f.ps_ratio || 0) < 2 ? 'good' : '') + '">' + (f.ps_ratio || 0).toFixed(2) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">P/B Ratio</span><span class="value">' + (f.pb_ratio || 0).toFixed(2) + 'x</span></div>' +
                '<div class="metric-row"><span class="label">Market Cap</span><span class="value">' + formatNum(q.market_cap) + '</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üìä Profitability</div>' +
                '<div class="metric-row"><span class="label">ROA</span><span class="value ' + ((f.roa || 0) > 10 ? 'good' : (f.roa || 0) > 5 ? 'warn' : '') + '">' + (f.roa || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">ROE</span><span class="value ' + ((f.roe || 0) > 10 ? 'good' : (f.roe || 0) > 5 ? 'warn' : '') + '">' + (f.roe || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">Profit Margin</span><span class="value ' + ((f.profit_margin || 0) > 10 ? 'good' : '') + '">' + (f.profit_margin || 0).toFixed(1) + '%</span></div>' +
                '<div class="metric-row"><span class="label">Gross Margin</span><span class="value">' + (f.gross_margin || 0).toFixed(1) + '%</span></div>' +
            '</div>' +
            '<div class="card"><div class="card-title">üè¶ Balance Sheet</div>' +
                '<div class="metric-row"><span class="label">Cash</span><span class="value good">' + formatNum(f.cash) + '</span></div>' +
                '<div class="metric-row"><span class="label">Debt</span><span class="value ' + ((f.debt || 0) > (f.cash || 0) ? 'bad' : '') + '">' + formatNum(f.debt) + '</span></div>' +
                '<div class="metric-row"><span class="label">Net Cash</span><span class="value ' + ((f.cash || 0) >= (f.debt || 0) ? 'good' : 'bad') + '">' + formatNum((f.cash || 0) - (f.debt || 0)) + '</span></div>' +
                '<div class="metric-row"><span class="label">Free Cash Flow</span><span class="value ' + ((f.fcf || 0) > 0 ? 'good' : 'bad') + '">' + formatNum(f.fcf) + '</span></div>' +
            '</div>' +
            '<div class="card score-card"><div class="card-title">‚≠ê Investment Score</div>' +
                '<div class="score-ring">' +
                    '<svg width="140" height="140"><circle class="bg" cx="70" cy="70" r="55"></circle><circle cx="70" cy="70" r="55" stroke="' + col + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + off + '" stroke-linecap="round"></circle></svg>' +
                    '<div class="score-text"><div class="num" style="color:' + col + '">' + score + '</div><div class="label">/100</div></div>' +
                '</div>' +
                '<ul class="checklist">' + checklistHtml + '</ul>' +
            '</div>' +
        '</div>';
    
    document.getElementById('detail').className = 'detail-view active';
}

function back() {
    document.getElementById('detail').className = 'detail-view';
    document.getElementById('grid').style.display = 'block';
}

function showError(msg) {
    document.getElementById('error').textContent = msg;
    document.getElementById('error').style.display = 'block';
    setTimeout(function() { document.getElementById('error').style.display = 'none'; }, 5000);
}

function formatNum(n) {
    if (!n && n !== 0) return 'N/A';
    if (Math.abs(n) >= 1e12) return '$' + (n/1e12).toFixed(1) + 'T';
    if (Math.abs(n) >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return '$' + (n/1e6).toFixed(0) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}

// Load tickers for autocomplete
async function loadTickers() {
    try {
        const resp = await fetch(API_BASE + '/api/tickers');
        const data = await resp.json();
        
        if (data.tickers) {
            const datalist = document.getElementById('tickerList');
            const popular = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM', 'V', 'WMT', 'DIS', 'NFLX', 'AMD', 'INTC', 'BA'];
            popular.forEach(function(t) {
                const opt = document.createElement('option');
                opt.value = t;
                datalist.appendChild(opt);
            });
        }
    } catch (e) {}
}

// Enter key support
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') analyze();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadTickers();
    loadDefaultStocks();
});
</script>
</body>
</html>
